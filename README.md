## Purpose
This guide walks through setting up a secure login system in Next.js using Better Auth, Prisma ORM, PostgreSQL, Nodemailer, and ShadCN UI components. It covers initial setup, dependency installation, database integration, and authentication flow implementation with best practices.

## Prerequisites
- Node.js (LTS recommended)
- npm (comes with Node.js)
- Visual Studio Code (or preferred code editor)
- PostgreSQL database (local or cloud via Neon.tech)
- Basic familiarity with:
  - Next.js
  - Tailwind CSS
  - Prisma ORM
  - Environment variables
  - REST API concepts

## Technologies used
Neon Database - to store our database
Prisma ORM
Nodemailer
Better Auth

# Part I
## Initial Setup
### Create a new next app
1. Run the create app command:
```bash
npx create-next-app@latest
```

2. Set a name for your project (login-app) and the rest leave it as defaults.
3. Open the repository
```bash
cd login-app/
# Open the repository in vs code
code .
```

4. Remove all files from `public/*`
5. Clear `src/app/globals.css` except @import "tailwindcss";
6. Clear `src/app/page.ts` and replace with:
```typescript
import { Button } from "@/components/ui/button";

export default function Page() {
  return (
    <div>
      <Button>
        Hello World!
      </Button>
      </div>
  );
}
```

> [!tip] **Verification**
>- Run:
>```bash
>npm run dev
>```
>- Open `http://localhost:3000` → You should see **Hello World!** inside a styled button.
>- No errors in terminal or browser console.
### install shadcn
1. Run install command
```bash
npx shadcn@latest init
```
Options:
	1 - Base color: Zinc
	2 - Select Use --legacy-peer-deps

2. Install components
```bash
npx shadcn@latest add button label input sonner
```
Options:
	1 - Select Use --legacy-peer-deps

> [!tip] **Verification**
>- Ensure the `@/components/ui/button` component exists.
>- Run:
>```bash
>npm run dev
>```
>- Add `<Button>Test</Button>` to any page → it should render with ShadCN styles.
## Part 1 - Basic login functionality using better auth
### install [Better Auth](https://www.better-auth.com/docs/installation)
1. Run the install command
```bash
npm install better-auth
```

2. Create a `.env` file in the root of your project and add the following environment variables:
```SQL
BETTER_AUTH_SECRET=cLxxodGti1ZMIP82PKb8Xu2JB34NIyZ3 --Secret Key generated by better auth
BETTER_AUTH_URL=http://localhost:3000 --Base URL of your app
NEXT_PUBLIC_API_URL="http://localhost:3000" --Used to access our API on client components (when you go to prod you change this to your actual domain)
```

> [!tip] **Verification**
> - `.env` file contains:
> 	- `BETTER_AUTH_SECRET`
> 	- `BETTER_AUTH_URL`
> 	- `NEXT_PUBLIC_API_URL`
> - Restart dev server and confirm no `.env` errors in terminal.

3. Create a file named `auth.ts` in `src/lib/` folder and import better-auth
```typescript
import { betterAuth } from "better-auth";
export const auth = betterAuth({}); //All better auth config with be inside this section
```
4. Setup `postgres` database with [neon.tech](https://console.neon.tech/)
5. Click on `New Peoject`
6. Set a project name `login-app`
7. Set a database name `betterauthdb`
8. Click `Create`
9. Go back to home screen and click on `Connect` and copy your connection string
10. Go to `.env` file and add this line
```SQL
DATABASE_URL={connection string} -- your connection string
```

> [!note]
> Recommended to use "" to wrap all environment variables for consistency and syntax reading
### Install [[Prisma]]
1. Run  the install command:
```bash
npm install prisma --save-dev
```
2. Initialize prisma
```bash
npx prisma init
```
3. A `prisma` folder must be created in your root folder, open the `schema.prisma` file inside
4. Create **Post** Model inside `schema.prisma`
```SQL
model Post {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title   String
  content String

  @@map("posts")
}
```

> [!tip] **Verification**
Push database changes
>```bash
>npx prisma db push
>```
>- No migration or connection errors appear.
>- In Neon dashboard (or local DB), verify that the tables (e.g., `Post`) exist.

5. Add `generated` to `.gitignore`
```git
# prisma
/src/generated/prisma
```
6. Adjust **scripts** in `package.json`, this will keep our web server sync with our prisma schema
```JSON
"scripts": {
    "dev": "prisma generate && next dev --turbopack", //Add this
    "build": "prisma generate && next build",         //Add this
    "start": "next start",
    "lint": "next lint"
  },
```
### Create single Prisma Client

>[!info] ### Best practices for using Prisma Client in development
>
>#### Avoid multiple Prisma Client instances
When developing a Next.js application, one common issue is accidentally creating multiple instances of the Prisma Client. This often occurs due to Next.js’s hot-reloading feature in development.
>
>##### Why this happens
Next.js’s hot-reloading feature reloads modules frequently to reflect code changes instantly. However, this can lead to multiple instances of Prisma Client being created, which consumes resources and might cause unexpected behavior.
>
>##### Recommended solution
To avoid this, create a single Prisma Client instance by using a global variable:
>```typescript
// lib/prisma.ts
import { PrismaClient } from "@/generated/prisma"; //make sure to update this line
>
const globalForPrisma = global as unknown as { prisma: PrismaClient };
>
export const prisma = 
>	globalForPrisma.prisma || new PrismaClient();
>
>if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;
>```
>Using this approach ensures that only one instance of Prisma Client exists, even during hot-reloading in development.
>
>[Article](https://www.prisma.io/docs/orm/more/help-and-troubleshooting/nextjs-help)
1. Go to `lib/` and create a file called `prisma.ts`
2. Add the code above.
### Setup prisma adapter with better-auth
1. Go to `src/lib/auth.ts` update the file to
```typescript
import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { prisma } from "@/lib/prisma";

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  })
});
```

>[!note]
>Now our prisma adapter is connected to better auth, the better auth CLI will know what we are using and what tables to actually generate for us.

> [!tip] **Verification**
Generate auth tables
>```bash
>npx @better-auth/cli generate --output=auth.schema.prisma #We add this comment to generate the tables in a separate file so we can later just copy an paste into our prisma schema
>```

Open the newly generated `auth.schema.prisma` file and copy tables 
- `User`
- `Session`
- `Account`
- `Verification

3. Go to `prisma/schema.prisma` and paste the tables, your `schema.prisma` should look like this:
```SQL
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
  
// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

  

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

  

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title   String
  content String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("posts")
}

--Newly added tables:
--sort the fields as convenient

model User {
  id        String   @id
  createdAt DateTime
  updatedAt DateTime

  name          String
  email         String  @unique
  emailVerified Boolean
  image         String?

  sessions Session[]
  accounts Account[]
  post     Post[]

  @@map("users")
}

model Session {
  id        String   @id
  createdAt DateTime
  updatedAt DateTime
  
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id        String   @id
  createdAt DateTime
  updatedAt DateTime

  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id        String    @id
  createdAt DateTime?
  updatedAt DateTime?

  identifier String
  value      String
  expiresAt  DateTime
  
  @@map("verifications")

}
```

> [!tip] **Verification**
>- Push database changes
>```bash
>npx prisma db push
>```
>- In your DB dashboard, confirm new auth-related tables exist (User, Session, Account, Verification).
>- Open Neon dashboard and go tot tables, verify your tables were created.

4. Delete `auth.schema.prisma` file.
### Create Mount Handler file
> [!info] ### [Mount Handler](https://www.better-auth.com/docs/installation#mount-handler)
To handle API requests, you need to set up a route handler on your server.
>
Create a new file or route in your framework's designated catch-all route handler. This route should handle requests for the path `/api/auth/*` (unless you've configured a different base path).
>
Better Auth supports any backend framework with standard Request and Response objects and offers helper functions for popular frameworks.
>

1.  Go to `app/api/auth/[...all]/`, and name your file `route.ts`, your file should look like this:
```typescript
// app/api/auth/[...all]/route.ts
import { auth } from "@/lib/auth"; // path to your auth file
import { toNextJsHandler } from "better-auth/next-js"; 

export const { POST, GET } = toNextJsHandler(auth);

//this route.ts file lives in /api/auth/[...all]

// Better auth will create may endpoint for you for example:
// /api/auth/sign-in
// /api/auth/sign-up
// /api/auth/get-session
```
### [Create Client Instance](https://www.better-auth.com/docs/installation#create-client-instance)
> [!info] 
> The client-side library helps you interact with the auth server. Better Auth comes with a client for all the popular web frameworks, including vanilla JavaScript.
>
>Import `createAuthClient` from the package for your framework (e.g., "better-auth/react" for React).
>
>Call the function to create your client.
>
>Pass the base URL of your auth server. (If the auth server is running on the same domain as your client, you can skip this step.)
>
If you're using a different base path other than `/api/auth` make sure to pass the whole URL including the path. (e.g. `http://localhost:3000/custom-path/auth`)

1. Go to `lib/` and create a `auth-client.ts` file to store your client instance, your file should look like this:
```typescript
// lib/auth-client.ts
import { createAuthClient } from "better-auth/react"
export const authClient = createAuthClient({    
	/** The base URL of the server (optional if you're using the same domain) */   
	baseURL: process.env.NEXT_PUBLIC_API_URL, //Public URL
})

/*Exporting specific things from the auth client as needed*/
export const {} = authClient
```

> [!note] **Note**
> You can also export specific methods if you prefer:
>```typescript
>export const { signIn, signUp, useSession } = createAuthClient()
>```
### [Enable Email & Password Authentication](https://www.better-auth.com/docs/basic-usage#email--password)
1. Modify `src/auth.ts` to:
```typescript
import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { prisma } from "@/lib/prisma";

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  }),
  emailAndPassword: {
    enabled: true,    //Property added
  },
});
```
### Create Sign Up Page
1. Create a `page.tsx` file inside `app/auth/register/` add these lines:
```typescript
import { RegisterForm } from "@/components/ui/register-form";
import { ReturnButton } from "@/components/ui/return-button";
import Link from "next/link";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <h1 className="text-3xl font-bold">Register</h1>
      </div>
      <RegisterForm />
      </p>
    </div>
  );
}
```
### Create a register form.
1. Create `register-form.tsx` file inside `src/components/ui/` and add these lines:
```typescript
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";

export const RegisterForm = () => {
	async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
		evt.preventDefault();
	}
	
	<form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
      <div className="space-y-2">
        <Label htmlFor="name">
          Name
        </Label>
        <Input
        id="name"
        name="name"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="email">
        Email
      </Label>
      <Input
        id="email"
        name="email"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="password">
        Password
      </Label>
      <Input
      type="password"
        id="password"
        name="password"
      />
    </div>
    <Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
    >
      Register
    </Button>
  </form>
};
```
### Setup Toaster
1. Go to `src/app/` and open `layout.tsx` file and add the Toaster component.
```typescript
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { Toaster } from "sonner";      //Import Toaster and add below

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

  

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
        <Toaster position="top-center" richColors/>  //Add Toaster component
      </body>
    </html>
  );
}
```

2. Go back to `src/components/ui/register-form.tsx` and add toasts to the form
```typescript
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";

  

export const RegisterForm = () => {
  const [isPending, setIsPending] = useState(false)
  const router = useRouter();

    async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
        evt.preventDefault();
       /********************   Setup Toast   *************************/
        const formData = new FormData(evt.target as HTMLFormElement);
        
        const name = String(formData.get("name"));
        if (!name) return toast.error("Name is required");
        const email = String(formData.get("email"));
        if (!email) return toast.error("Email is required");
        const password = String(formData.get("password"));
        if (!password) return toast.error("Password is required");
		/********************   Setup Toast   *************************/
		
		console.log({name, email, password}); // log to see in browser
    }

  return (
    <form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
      <div className="space-y-2">
        <Label htmlFor="name">
          Name
        </Label>
        <Input
        id="name"
        name="name"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="email">
        Email
      </Label>
      <Input
        id="email"
        name="email"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="password">
        Password
      </Label>
      <Input
      type="password"
        id="password"
        name="password"
      />
    </div>
    <Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
    >
      Register
    </Button>
  </form>
  );
};
```

>[!note]
>Better Auth requires a name variable for their API, if you don't require a name you can you pass a blank string

> [!tip] **Verification**
>- Run:
>```
>npm run dev
>```
>- Go to `/auth/register` → The register form should load without console errors.
>- Submitting with empty fields triggers toast error messages.
### Setup sign-up procedure
1. Go to `lib/auth-client.ts` and export the signUp function.
```typescript
import { createAuthClient } from "better-auth/react"

export const authClient = createAuthClient({
    /** The base URL of the server (optional if you're using the same domain) */
    baseURL: process.env.NEXT_PUBLIC_API_URL,
})

export const {
    signUp
} = authClient
```
2. Update `src/components/ui/register-form.tsx` and add imports at the top and these lines below toast:
```typescript
import { signUp } from "@/lib/auth-client";
import { useState } from "react";
import { useRouter } from "next/navigation";

//Delete the console log and add:
await signUp.email(
            {
                name,
                email,
                password
            },
            {
                onRequest: () => {
                  setIsPending(true);
                },
                onResponse: () => {
                  setIsPending(false);
                },
                onError: (ctx) => {
                    toast.error(ctx.error.message);
                },
                onSuccess: () => {
                  toast.success("Registration successful!");
                  router.push("/profile");
                }
            }
        )
    }
```

> [!tip] **Verification**
>- Fill out register form with valid name, email, password.
>- On success, check DB for a new user row.
>- Session cookie is set in browser (unless email verification is enabled).
### Modify better auth password length property
1. Go to `lib/auth.ts`, under emailAndPassword add the minPasswordLength property:
```typescript
export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  }),
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 6,              // Add this line
  },
});
```

> [!note]
> Better auth by default will sign you in automatically and create a session cookie on registration unless you have email verification on (email verification is off by default).
> 
if you run the server and register, you will see the new account is created in your database.
### Display your session on a Profile page
1. In the `/app` folder create a new folder called `/profile`, inside the folder create a `page.tsx` file.
```typescript
import { SignOutButton } from "@/components/sign-out-button"; // will be added later
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { ReturnButton } from "@/components/ui/return-button";

export default async function Page(){ //async for server component
/*****************   This is where we get our session   ****************/
    const session = await auth.api.getSession({
        headers: await headers()
    })
/***********************************************************************/
    if (!session) {
        return (
            <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
                <div className="space-y-8">
                    <h1 className="text-3xl font-bold">Please log in to view your profile</h1>
                </div>
            </div>
        )
    }

    return (
        <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
            <div className="space-y-8">
                <ReturnButton href="/auth/login" label="Back to Login" />
                <h1 className="text-3xl font-bold">Profile</h1>
            </div>
            <SignOutButton />  //Sign out button will be added later
            <pre className="text-sm overflow-clip">
                {JSON.stringify(session, null, 2)}  //Display session attributes
            </pre>
        </div>
    );
}
```
### Create a sign out button.
1. Go to `src/components/` create `sign-out-button.tsx` file
```typescript
"use client"; // Define it's a client component

import { Button } from "@/components/ui/button"
import { useRouter } from "next/navigation";
import { signOut } from "@/lib/auth-client";
import { toast } from "sonner";
import { useState } from "react";

export const SignOutButton = () => {
    const [isPending, setIsPending] = useState(false);
    const router = useRouter();

/*********************   On click handler button   **************************/
    async function handleClick() {
        await signOut({
            fetchOptions: {
                onRequest: () => {
                  setIsPending(true);
                },
                onResponse: () => {
                  setIsPending(false);
                },
                onError: (ctx) => {
                    toast.error(ctx.error.message);
                },
                onSuccess: () => {
                    toast.success("Signed out successfully");
                    router.push("/auth/login");   // Use router hook to redirect
                },
            },
        });
    }
/*****************************************************************************/
    return (
        <Button onClick={handleClick} size="sm" variant="destructive" disabled={isPending}>
            Sign Out
        </Button>
    )
};
```
### Create a login page
2. Go to `src/app/auth/` create a `/login` folder and a `page.tsx` file within it.
```typescript
import { LoginForm } from "@/components/ui/login-form";
import { ReturnButton } from "@/components/ui/return-button";
import Link from "next/link";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/" label="Back to Home" />
        <h1 className="text-3xl font-bold">Login</h1>
      </div>

      <LoginForm />
      <p className="text-muted-foreground text-sm">
        Don't have an account?{" "}
        <Link href="/auth/register" className="text-blue-600 hover:underline">
          Register
        </Link>
      </p>
    </div>
  );
}
```
2. Go to `src/components` and create `login-form.tsx` file
```typescript
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { signIn } from "@/lib/auth-client";
import { useRouter } from "next/navigation";
import { useState } from "react";

export const LoginForm = () => {
  const [isPending, setIsPending] = useState(false)
  const router = useRouter();
  
/*********************   On click handler button   **************************/
    async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
        evt.preventDefault();
        const formData = new FormData(evt.target as HTMLFormElement);
  
        const email = String(formData.get("email"));
        if (!email) return toast.error("Email is required");
        const password = String(formData.get("password"));
        if (!password) return toast.error("Password is required");
  
        await signIn.email({
          email,
          password
        },
      {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error(ctx.error.message);
        },
        onSuccess: () => {
          toast.success("Login successful!");
          router.push("/profile");
        }
      })
    }
/*****************************************************************************/

  return (
    <form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
    <div className="space-y-2">
      <Label htmlFor="email">
        Email
      </Label>
      <Input
        id="email"
        name="email"
      />

    </div>
    <div className="space-y-2">
      <Label htmlFor="password">
        Password
      </Label>
      <Input
      type="password"
        id="password"
        name="password"
      />
    </div>
    <Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
    >
      Login
    </Button>
  </form>
  );
};
```
3. Go to `lib/auth-client.ts` and export the sing in function
```typescript
import { createAuthClient } from "better-auth/react" 

export const authClient = createAuthClient({
    /** The base URL of the server (optional if you're using the same domain) */
    baseURL: process.env.NEXT_PUBLIC_API_URL,
})

export const {
    signUp,
    signOut,
    signIn
} = authClient
```

> [!tip] **Verification**
>- Go to `/auth/login` → The login form should render.
>- Log in with an existing user → Redirects to `/profile` and displays session details.
# Part II - Email & Password Authentication
## Return button component
1. go to `src/components/ui` and create `return-button.tsx` file.
```typescript
// src/components/ui/return-button.tsx
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { ArrowLeftIcon } from "lucide-react";

interface ReturnButtonProps {
    href: string;
    label: string;
}

export const ReturnButton = ({ href, label }: ReturnButtonProps) => {
    return (
        <Button size="sm" asChild>
            <Link href={href}>
                <ArrowLeftIcon /> {label}
            </Link>
        </Button>
    );
};
```

2. we will add these in every page we have.
```typescript
// src/auth/register/page.tsx
<ReturnButton href="/auth/login" label="Back to Login" /> //add above h1 Register

// src/auth/login/page.tsx
<ReturnButton href="/" label="Back to Home" /> // add above h1 Login

//  src/auth/profile/page.tsx
<ReturnButton href="/auth/login" label="Back to Login" /> // add above h1 Profile
```

## Make use of onRequest & onResponse properties
1. Go to `src/components/ui/register-form.tsx` and add the loading state inside the Register form function:
```typescript
import { useState } from "react";
/*********************************************************/
export const RegisterForm = () => {
  const [isPending, setIsPending] = useState(false);
  const router = useRouter(); // Add router too for the onSuccess function
/*********************************************************/
```
2. Update the onRequest, onResponse functions:
```typescript
// src/components/ui/register-form.tsx
{
	onRequest: () => {
	  setIsPending(true);
	},
	onResponse: () => {
	  setIsPending(false);
	},
	onError: (ctx) => {
		toast.error(ctx.error.message);
	},
	onSuccess: () => {
	  toast.success("Registration successful!");
	  router.push("/profile");
	}
}
/*********************************************************/
// add isPending property to Button
<Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
>
```
3. Do the same for `login-form` & `sign-out-button`
```typescript
// login-form & sign-out-button
import { useState } from "react";
/*********************************************************/
export const LoginForm = () => {
  const [isPending, setIsPending] = useState(false)
  const router = useRouter();
/*********************************************************/
onRequest: () => {
  setIsPending(true);
},
onResponse: () => {
  setIsPending(false);
},
onError: (ctx) => {
  toast.error(ctx.error.message);
}
/*********************************************************/
// onSuccess login-form
onSuccess: () => {
  toast.success("Login successful!");
  router.push("/profile");
}
// onSuccess Sign-out-button
onSuccess: () => {
	toast.success("Signed out successfully");
	router.push("/auth/login");
}
```
4. Add convenience links to move around the page
```typescript
// src/app/auth/login/page.tsx & ~/register/page.tsx
import Link from "next/link";
/*********************************************************/
// login/page.tsx add p below <loginForm /> component
<p className="text-muted-foreground text-sm">
	Don't have an account?{" "}
	<Link href="/auth/register" className="text-blue-600 hover:underline">
	  Register
	</Link>
</p>
/*********************************************************/
// register/page.tsx add p below <RegisterForm /> component
<p className="text-muted-foreground text-sm">
	Already have an account?{" "}
	<Link href="/auth/login" className="text-blue-600 hover:underline">
	  Login
	</Link>
</p>
```

> [!tip] **Verification**
> 1. Run the server
> ```typescript
> npm run dev
> ```
>2.  Create and account, verify the register button is disabled when you click on it and you get redirected to your profile.
>3. Click the sign out button and verify it has a loading state as well, you should be redirected to the login page.
>4. Click on the Register link and verify you get redirected to the register form, verify the login link works the same way around.

## Disable better auth to sign you in automatically
1. Go to `src/lib/auth.ts` and add the autoSignIn property.
```typescript
emailAndPassword: {
    enabled: true,
    minPasswordLength: 6,
    autoSignIn: false,   // Add this line
}
```
## Customize the sys_id of our database records
1. Go to `src/lib/auth.ts` and add the advanced option below emailAndPassword.
```typescript
advanced: {
	database: {
	  generateId: false,
	}
}
```
2. go back to `prisma/schema.prisma` and add the `@default(uuid())` property on each ID.
3. Push changes to postgres database
```bash
npx prisma db push
```
4. Delete all current users in your postrges database.
5. Delete your browser cookie manually.

> [!tip] **Verification**
> 1. Start your dev server
> ```bash
> npm run dev
> ```
> 2. Register a new account, once you click on register verify you get redirected to the unauthorized form.
> 3. Open you neon database and verify the sys_id of your record is uuid

## Customize your password hash algorithm
1. Install Argon2 algorithm for hashing.
```bash
npm install @node-rs/argon2
```
2. Update `next.config.ts` file to include argon2.
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  serverExternalPackages: ["@node-rs/argon2"],  //Add this line
};

export default nextConfig;
```
3. Go to `src/lib/` and create a new argon2 config file called `argon2.ts`.
```typescript
// argon2.ts
import { hash, verify, type Options } from "@node-rs/argon2";
const opts: Options = {
//Recommended minimum parameters
    memoryCost: 19456,
    timeCost: 2,
    outputLen: 32,
    parallelism: 1,
}
/***************   We export next two functions   ***************/
export async function hashPassword(password: string){
    const result = await hash(password, opts);
    return result
}
  
//Function is defined this way because this is the way better auth wants us to define hashing funcions
export async function verifyPassword(data: { password: string, hash: string}) {
    const { password, hash } = data;
    const result = await verify(hash, password, opts);
    return result;
}
```

> [!note] Lucia Auth recommended minimum parameters
> For a simple password-based auth, the password can just be stored in the user table.
>
>```typescript
>const passwordHash = await hash(password, {
>	// recommended minimum parameters
>	memoryCost: 19456,
>	timeCost: 2,
>	outputLen: 32,
>	parallelism: 1
>});
>const userId = generateIdFromEntropySize(10); // 16 characters long
>
>await db.table("user").insert({
>	id: userId,
>	email,
>	password_hash: passwordHash
>});
>```
> [Article](https://v3.lucia-auth.com/upgrade-v3/)

4. Go to `src/lib/auth.ts` and add the password property to emailAndPassword.
```typescript
import { hashPassword, verifyPassword } from "@/lib/argon2";

/***************************************************************/
emailAndPassword: {
	enabled: true,
	minPasswordLength: 6,
	autoSignIn: false,
	password: {
	  hash: hashPassword, // your custom password hashing function
	  verify: verifyPassword // your custom password verification function
	}
}
```

> [!tip] **Verification**
> 1. Start your dev server.
> ```bash
> npm run dev
> ```
> 2. Register an account.
> 3. Open your neon database
> 4. Go to accounts table and verify the password property is hashed with your hashing algorithm. (argo2 passwords look something like this: $argon2id$v=19$m=19456,t=2,p=1$)

## References
- [Next.js Documentation](https://nextjs.org/docs)
- [Better Auth Documentation](https://www.better-auth.com/docs)
- [Prisma ORM Documentation](https://www.prisma.io/docs)
- [Neon Database](https://neon.tech)
- [Nodemailer](https://nodemailer.com/about/)
