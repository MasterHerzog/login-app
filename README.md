## Purpose
This guide walks through setting up a secure login system in Next.js using Better Auth, Prisma ORM, PostgreSQL, Nodemailer, and ShadCN UI components. It covers initial setup, dependency installation, database integration, and authentication flow implementation with best practices.

## Prerequisites
- Node.js (LTS recommended)
- npm (comes with Node.js)
- Visual Studio Code (or preferred code editor)
- PostgreSQL database (local or cloud via Neon.tech)
- Basic familiarity with:
  - Next.js
  - Tailwind CSS
  - Prisma ORM
  - Environment variables
  - REST API concepts

## Technologies used
- Neon Database - to store our database
- Prisma ORM
- Nodemailer
- Better Auth

# Part I
## Initial Setup
### Create a new next app
1. Run the create app command:
```bash
npx create-next-app@latest
```

2. Set a name for your project (login-app) and the rest leave it as defaults.
3. Open the repository
```bash
cd login-app/
# Open the repository in vs code
code .
```

4. Remove all files from `public/*`
5. Clear `src/app/globals.css` except @import "tailwindcss";
6. Clear `src/app/page.ts` and replace with:
```typescript
import { Button } from "@/components/ui/button";

export default function Page() {
  return (
    <div>
      <Button>
        Hello World!
      </Button>
      </div>
  );
}
```

> [!tip] **Verification**
>- Run:
>```bash
>npm run dev
>```
>- Open `http://localhost:3000` → You should see **Hello World!** inside a styled button.
>- No errors in terminal or browser console.
### install shadcn
1. Run install command
```bash
npx shadcn@latest init
```
Options:
	1 - Base color: Zinc
	2 - Select Use --legacy-peer-deps

2. Install components
```bash
npx shadcn@latest add button label input sonner
```
Options:
	1 - Select Use --legacy-peer-deps

> [!tip] **Verification**
>- Ensure the `@/components/ui/button` component exists.
>- Run:
>```bash
>npm run dev
>```
>- Add `<Button>Test</Button>` to any page → it should render with ShadCN styles.
## Part 1 - Basic login functionality using better auth
### install [Better Auth](https://www.better-auth.com/docs/installation)
1. Run the install command
```bash
npm install better-auth
```

2. Create a `.env` file in the root of your project and add the following environment variables:
```SQL
BETTER_AUTH_SECRET=your-better-auth-secret --Secret Key generated by better auth
BETTER_AUTH_URL=http://localhost:3000 --Base URL of your app
NEXT_PUBLIC_API_URL="http://localhost:3000" --Used to access our API on client components (when you go to prod you change this to your actual domain)
```

> [!tip] **Verification**
> - `.env` file contains:
> 	- `BETTER_AUTH_SECRET`
> 	- `BETTER_AUTH_URL`
> 	- `NEXT_PUBLIC_API_URL`
> - Restart dev server and confirm no `.env` errors in terminal.

3. Create a file named `auth.ts` in `src/lib/` folder and import better-auth
```typescript
import { betterAuth } from "better-auth";
export const auth = betterAuth({}); //All better auth config with be inside this section
```
4. Setup `postgres` database with [neon.tech](https://console.neon.tech/)
5. Click on `New Peoject`
6. Set a project name `login-app`
7. Set a database name `betterauthdb`
8. Click `Create`
9. Go back to home screen and click on `Connect` and copy your connection string
10. Go to `.env` file and add this line
```SQL
DATABASE_URL={connection string} -- your connection string
```

> [!note]
> Recommended to use "" to wrap all environment variables for consistency and syntax reading
### Install [[Prisma]]
1. Run  the install command:
```bash
npm install prisma --save-dev
```
2. Initialize prisma
```bash
npx prisma init
```
3. A `prisma` folder must be created in your root folder, open the `schema.prisma` file inside
4. Create **Post** Model inside `schema.prisma`
```SQL
model Post {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title   String
  content String

  @@map("posts")
}
```

> [!tip] **Verification**
Push database changes
>```bash
>npx prisma db push
>```
>- No migration or connection errors appear.
>- In Neon dashboard (or local DB), verify that the tables (e.g., `Post`) exist.

5. Add `generated` to `.gitignore`
```git
# prisma
/src/generated/prisma
```
6. Adjust **scripts** in `package.json`, this will keep our web server sync with our prisma schema
```JSON
"scripts": {
    "dev": "prisma generate && next dev --turbopack", //Add this
    "build": "prisma generate && next build",         //Add this
    "start": "next start",
    "lint": "next lint"
  },
```
### Create single Prisma Client

>[!note] 
>**Best practices for using Prisma Client in development**
>
>**Avoid multiple Prisma Client instances**
When developing a Next.js application, one common issue is accidentally creating multiple instances of the Prisma Client. This often occurs due to Next.js’s hot-reloading feature in development.
>
>**Why this happens**
Next.js’s hot-reloading feature reloads modules frequently to reflect code changes instantly. However, this can lead to multiple instances of Prisma Client being created, which consumes resources and might cause unexpected behavior.
>
>**Recommended solution**
To avoid this, create a single Prisma Client instance by using a global variable:
>```typescript
// lib/prisma.ts
import { PrismaClient } from "@/generated/prisma"; //make sure to update this line
>
const globalForPrisma = global as unknown as { prisma: PrismaClient };
>
export const prisma = 
>	globalForPrisma.prisma || new PrismaClient();
>
>if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;
>```
>Using this approach ensures that only one instance of Prisma Client exists, even during hot-reloading in development.
>
>[Article](https://www.prisma.io/docs/orm/more/help-and-troubleshooting/nextjs-help)
1. Go to `lib/` and create a file called `prisma.ts`
2. Add the code above.
### Setup prisma adapter with better-auth
1. Go to `src/lib/auth.ts` update the file to
```typescript
import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { prisma } from "@/lib/prisma";

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  })
});
```

>[!note]
>Now our prisma adapter is connected to better auth, the better auth CLI will know what we are using and what tables to actually generate for us.

> [!tip] **Verification**
Generate auth tables
>```bash
>npx @better-auth/cli generate --output=auth.schema.prisma #We add this comment to generate the tables in a separate file so we can later just copy an paste into our prisma schema
>```

Open the newly generated `auth.schema.prisma` file and copy tables 
- `User`
- `Session`
- `Account`
- `Verification

3. Go to `prisma/schema.prisma` and paste the tables, your `schema.prisma` should look like this:
```SQL
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
  
// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

  

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

  

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title   String
  content String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("posts")
}

--Newly added tables:
--sort the fields as convenient

model User {
  id        String   @id
  createdAt DateTime
  updatedAt DateTime

  name          String
  email         String  @unique
  emailVerified Boolean
  image         String?

  sessions Session[]
  accounts Account[]
  post     Post[]

  @@map("users")
}

model Session {
  id        String   @id
  createdAt DateTime
  updatedAt DateTime
  
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id        String   @id
  createdAt DateTime
  updatedAt DateTime

  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id        String    @id
  createdAt DateTime?
  updatedAt DateTime?

  identifier String
  value      String
  expiresAt  DateTime
  
  @@map("verifications")

}
```

> [!tip] **Verification**
>- Push database changes
>```bash
>npx prisma db push
>```
>- In your DB dashboard, confirm new auth-related tables exist (User, Session, Account, Verification).
>- Open Neon dashboard and go tot tables, verify your tables were created.

4. Delete `auth.schema.prisma` file.
### Create Mount Handler file
> [!note]
> [**Mount Handler**](https://www.better-auth.com/docs/installation#mount-handler)
To handle API requests, you need to set up a route handler on your server.
>
Create a new file or route in your framework's designated catch-all route handler. This route should handle requests for the path `/api/auth/*` (unless you've configured a different base path).
>
Better Auth supports any backend framework with standard Request and Response objects and offers helper functions for popular frameworks.
>

1.  Go to `app/api/auth/[...all]/`, and name your file `route.ts`, your file should look like this:
```typescript
// app/api/auth/[...all]/route.ts
import { auth } from "@/lib/auth"; // path to your auth file
import { toNextJsHandler } from "better-auth/next-js"; 

export const { POST, GET } = toNextJsHandler(auth);

//this route.ts file lives in /api/auth/[...all]

// Better auth will create may endpoint for you for example:
// /api/auth/sign-in
// /api/auth/sign-up
// /api/auth/get-session
```
### Create Client Instance
> [!note]
> [**Create Client Instance**](https://www.better-auth.com/docs/installation#create-client-instance) 
> The client-side library helps you interact with the auth server. Better Auth comes with a client for all the popular web frameworks, including vanilla JavaScript.
>
>Import `createAuthClient` from the package for your framework (e.g., "better-auth/react" for React).
>
>Call the function to create your client.
>
>Pass the base URL of your auth server. (If the auth server is running on the same domain as your client, you can skip this step.)
>
If you're using a different base path other than `/api/auth` make sure to pass the whole URL including the path. (e.g. `http://localhost:3000/custom-path/auth`)

1. Go to `lib/` and create a `auth-client.ts` file to store your client instance, your file should look like this:
```typescript
// lib/auth-client.ts
import { createAuthClient } from "better-auth/react"
export const authClient = createAuthClient({    
	/** The base URL of the server (optional if you're using the same domain) */   
	baseURL: process.env.NEXT_PUBLIC_API_URL, //Public URL
})

/*Exporting specific things from the auth client as needed*/
export const {} = authClient
```

> [!note] **Note**
> You can also export specific methods if you prefer:
>```typescript
>export const { signIn, signUp, useSession } = createAuthClient()
>```
### [Enable Email & Password Authentication](https://www.better-auth.com/docs/basic-usage#email--password)
1. Modify `src/auth.ts` to:
```typescript
import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { prisma } from "@/lib/prisma";

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  }),
  emailAndPassword: {
    enabled: true,    //Property added
  },
});
```
### Create Sign Up Page
1. Create a `page.tsx` file inside `app/auth/register/` add these lines:
```typescript
import { RegisterForm } from "@/components/ui/register-form";
import { ReturnButton } from "@/components/ui/return-button";
import Link from "next/link";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <h1 className="text-3xl font-bold">Register</h1>
      </div>
      <RegisterForm />
      </p>
    </div>
  );
}
```
### Create a register form.
1. Create `register-form.tsx` file inside `src/components/ui/` and add these lines:
```typescript
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";

export const RegisterForm = () => {
	async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
		evt.preventDefault();
	}
	
	<form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
      <div className="space-y-2">
        <Label htmlFor="name">
          Name
        </Label>
        <Input
        id="name"
        name="name"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="email">
        Email
      </Label>
      <Input
        id="email"
        name="email"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="password">
        Password
      </Label>
      <Input
      type="password"
        id="password"
        name="password"
      />
    </div>
    <Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
    >
      Register
    </Button>
  </form>
};
```
### Setup Toaster
1. Go to `src/app/` and open `layout.tsx` file and add the Toaster component.
```typescript
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { Toaster } from "sonner";      //Import Toaster and add below

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

  

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
        <Toaster position="top-center" richColors/>  //Add Toaster component
      </body>
    </html>
  );
}
```

2. Go back to `src/components/ui/register-form.tsx` and add toasts to the form
```typescript
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";

  

export const RegisterForm = () => {
  const [isPending, setIsPending] = useState(false)
  const router = useRouter();

    async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
        evt.preventDefault();
       /********************   Setup Toast   *************************/
        const formData = new FormData(evt.target as HTMLFormElement);
        
        const name = String(formData.get("name"));
        if (!name) return toast.error("Name is required");
        const email = String(formData.get("email"));
        if (!email) return toast.error("Email is required");
        const password = String(formData.get("password"));
        if (!password) return toast.error("Password is required");
		/********************   Setup Toast   *************************/
		
		console.log({name, email, password}); // log to see in browser
    }

  return (
    <form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
      <div className="space-y-2">
        <Label htmlFor="name">
          Name
        </Label>
        <Input
        id="name"
        name="name"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="email">
        Email
      </Label>
      <Input
        id="email"
        name="email"
      />
    </div>
    <div className="space-y-2">
      <Label htmlFor="password">
        Password
      </Label>
      <Input
      type="password"
        id="password"
        name="password"
      />
    </div>
    <Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
    >
      Register
    </Button>
  </form>
  );
};
```

>[!note]
>Better Auth requires a name variable for their API, if you don't require a name you can you pass a blank string

> [!tip] **Verification**
>- Run:
>```
>npm run dev
>```
>- Go to `/auth/register` → The register form should load without console errors.
>- Submitting with empty fields triggers toast error messages.
### Setup sign-up procedure
1. Go to `lib/auth-client.ts` and export the signUp function.
```typescript
import { createAuthClient } from "better-auth/react"

export const authClient = createAuthClient({
    /** The base URL of the server (optional if you're using the same domain) */
    baseURL: process.env.NEXT_PUBLIC_API_URL,
})

export const {
    signUp
} = authClient
```
2. Update `src/components/ui/register-form.tsx` and add imports at the top and these lines below toast:
```typescript
import { signUp } from "@/lib/auth-client";
import { useState } from "react";
import { useRouter } from "next/navigation";

//Delete the console log and add:
await signUp.email(
            {
                name,
                email,
                password
            },
            {
                onRequest: () => {
                  setIsPending(true);
                },
                onResponse: () => {
                  setIsPending(false);
                },
                onError: (ctx) => {
                    toast.error(ctx.error.message);
                },
                onSuccess: () => {
                  toast.success("Registration successful!");
                  router.push("/profile");
                }
            }
        )
    }
```

> [!tip] **Verification**
>- Fill out register form with valid name, email, password.
>- On success, check DB for a new user row.
>- Session cookie is set in browser (unless email verification is enabled).
### Modify better auth password length property
1. Go to `lib/auth.ts`, under emailAndPassword add the minPasswordLength property:
```typescript
export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  }),
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 6,              // Add this line
  },
});
```

> [!note]
> Better auth by default will sign you in automatically and create a session cookie on registration unless you have email verification on (email verification is off by default).
> 
if you run the server and register, you will see the new account is created in your database.
### Display your session on a Profile page
1. In the `/app` folder create a new folder called `/profile`, inside the folder create a `page.tsx` file.
```typescript
import { SignOutButton } from "@/components/sign-out-button"; // will be added later
import { auth } from "@/lib/auth"
import { headers } from "next/headers"
import { ReturnButton } from "@/components/ui/return-button";

export default async function Page(){ //async for server component
/*****************   This is where we get our session   ****************/
    const session = await auth.api.getSession({
        headers: await headers()
    })
/***********************************************************************/
    if (!session) {
        return (
            <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
                <div className="space-y-8">
                    <h1 className="text-3xl font-bold">Please log in to view your profile</h1>
                </div>
            </div>
        )
    }

    return (
        <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
            <div className="space-y-8">
                <ReturnButton href="/auth/login" label="Back to Login" />
                <h1 className="text-3xl font-bold">Profile</h1>
            </div>
            <SignOutButton />  //Sign out button will be added later
            <pre className="text-sm overflow-clip">
                {JSON.stringify(session, null, 2)}  //Display session attributes
            </pre>
        </div>
    );
}
```
### Create a sign out button.
1. Go to `src/components/` create `sign-out-button.tsx` file
```typescript
"use client"; // Define it's a client component

import { Button } from "@/components/ui/button"
import { useRouter } from "next/navigation";
import { signOut } from "@/lib/auth-client";
import { toast } from "sonner";
import { useState } from "react";

export const SignOutButton = () => {
    const [isPending, setIsPending] = useState(false);
    const router = useRouter();

/*********************   On click handler button   **************************/
    async function handleClick() {
        await signOut({
            fetchOptions: {
                onRequest: () => {
                  setIsPending(true);
                },
                onResponse: () => {
                  setIsPending(false);
                },
                onError: (ctx) => {
                    toast.error(ctx.error.message);
                },
                onSuccess: () => {
                    toast.success("Signed out successfully");
                    router.push("/auth/login");   // Use router hook to redirect
                },
            },
        });
    }
/*****************************************************************************/
    return (
        <Button onClick={handleClick} size="sm" variant="destructive" disabled={isPending}>
            Sign Out
        </Button>
    )
};
```
### Create a login page
2. Go to `src/app/auth/` create a `/login` folder and a `page.tsx` file within it.
```typescript
import { LoginForm } from "@/components/ui/login-form";
import { ReturnButton } from "@/components/ui/return-button";
import Link from "next/link";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/" label="Back to Home" />
        <h1 className="text-3xl font-bold">Login</h1>
      </div>

      <LoginForm />
      <p className="text-muted-foreground text-sm">
        Don't have an account?{" "}
        <Link href="/auth/register" className="text-blue-600 hover:underline">
          Register
        </Link>
      </p>
    </div>
  );
}
```
2. Go to `src/components` and create `login-form.tsx` file
```typescript
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { signIn } from "@/lib/auth-client";
import { useRouter } from "next/navigation";
import { useState } from "react";

export const LoginForm = () => {
  const [isPending, setIsPending] = useState(false)
  const router = useRouter();
  
/*********************   On click handler button   **************************/
    async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
        evt.preventDefault();
        const formData = new FormData(evt.target as HTMLFormElement);
  
        const email = String(formData.get("email"));
        if (!email) return toast.error("Email is required");
        const password = String(formData.get("password"));
        if (!password) return toast.error("Password is required");
  
        await signIn.email({
          email,
          password
        },
      {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error(ctx.error.message);
        },
        onSuccess: () => {
          toast.success("Login successful!");
          router.push("/profile");
        }
      })
    }
/*****************************************************************************/

  return (
    <form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
    <div className="space-y-2">
      <Label htmlFor="email">
        Email
      </Label>
      <Input
        id="email"
        name="email"
      />

    </div>
    <div className="space-y-2">
      <Label htmlFor="password">
        Password
      </Label>
      <Input
      type="password"
        id="password"
        name="password"
      />
    </div>
    <Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
    >
      Login
    </Button>
  </form>
  );
};
```
3. Go to `lib/auth-client.ts` and export the sing in function
```typescript
import { createAuthClient } from "better-auth/react" 

export const authClient = createAuthClient({
    /** The base URL of the server (optional if you're using the same domain) */
    baseURL: process.env.NEXT_PUBLIC_API_URL,
})

export const {
    signUp,
    signOut,
    signIn
} = authClient
```

> [!tip] **Verification**
>- Go to `/auth/login` → The login form should render.
>- Log in with an existing user → Redirects to `/profile` and displays session details.
# Part II - Email & Password Authentication
## Return button component
1. go to `src/components/ui` and create `return-button.tsx` file.
```typescript
// src/components/ui/return-button.tsx
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { ArrowLeftIcon } from "lucide-react";

interface ReturnButtonProps {
    href: string;
    label: string;
}

export const ReturnButton = ({ href, label }: ReturnButtonProps) => {
    return (
        <Button size="sm" asChild>
            <Link href={href}>
                <ArrowLeftIcon /> {label}
            </Link>
        </Button>
    );
};
```

2. we will add these in every page we have.
```typescript
// src/auth/register/page.tsx
<ReturnButton href="/auth/login" label="Back to Login" /> //add above h1 Register

// src/auth/login/page.tsx
<ReturnButton href="/" label="Back to Home" /> // add above h1 Login

//  src/auth/profile/page.tsx
<ReturnButton href="/auth/login" label="Back to Login" /> // add above h1 Profile
```

## Make use of onRequest & onResponse properties
1. Go to `src/components/ui/register-form.tsx` and add the loading state inside the Register form function:
```typescript
import { useState } from "react";
/*********************************************************/
export const RegisterForm = () => {
  const [isPending, setIsPending] = useState(false);
  const router = useRouter(); // Add router too for the onSuccess function
/*********************************************************/
```
2. Update the onRequest, onResponse functions:
```typescript
// src/components/ui/register-form.tsx
{
	onRequest: () => {
	  setIsPending(true);
	},
	onResponse: () => {
	  setIsPending(false);
	},
	onError: (ctx) => {
		toast.error(ctx.error.message);
	},
	onSuccess: () => {
	  toast.success("Registration successful!");
	  router.push("/profile");
	}
}
/*********************************************************/
// add isPending property to Button
<Button
      type="submit"
      className="w-full bg-blue-600 text-white py-2 rounded-md"
      disabled={isPending}
>
```
3. Do the same for `login-form` & `sign-out-button`
```typescript
// login-form & sign-out-button
import { useState } from "react";
/*********************************************************/
export const LoginForm = () => {
  const [isPending, setIsPending] = useState(false)
  const router = useRouter();
/*********************************************************/
onRequest: () => {
  setIsPending(true);
},
onResponse: () => {
  setIsPending(false);
},
onError: (ctx) => {
  toast.error(ctx.error.message);
}
/*********************************************************/
// onSuccess login-form
onSuccess: () => {
  toast.success("Login successful!");
  router.push("/profile");
}
// onSuccess Sign-out-button
onSuccess: () => {
	toast.success("Signed out successfully");
	router.push("/auth/login");
}
```
4. Add convenience links to move around the page
```typescript
// src/app/auth/login/page.tsx & ~/register/page.tsx
import Link from "next/link";
/*********************************************************/
// login/page.tsx add p below <loginForm /> component
<p className="text-muted-foreground text-sm">
	Don't have an account?{" "}
	<Link href="/auth/register" className="text-blue-600 hover:underline">
	  Register
	</Link>
</p>
/*********************************************************/
// register/page.tsx add p below <RegisterForm /> component
<p className="text-muted-foreground text-sm">
	Already have an account?{" "}
	<Link href="/auth/login" className="text-blue-600 hover:underline">
	  Login
	</Link>
</p>
```

> [!tip] **Verification**
> 1. Run the server
> ```typescript
> npm run dev
> ```
>2.  Create and account, verify the register button is disabled when you click on it and you get redirected to your profile.
>3. Click the sign out button and verify it has a loading state as well, you should be redirected to the login page.
>4. Click on the Register link and verify you get redirected to the register form, verify the login link works the same way around.

## Disable better auth to sign you in automatically
1. Go to `src/lib/auth.ts` and add the autoSignIn property.
```typescript
emailAndPassword: {
    enabled: true,
    minPasswordLength: 6,
    autoSignIn: false,   // Add this line
}
```
## Customize the sys_id of our database records
1. Go to `src/lib/auth.ts` and add the advanced option below emailAndPassword.
```typescript
advanced: {
	database: {
	  generateId: false,
	}
}
```
2. go back to `prisma/schema.prisma` and add the `@default(uuid())` property on each ID.
3. Push changes to postgres database
```bash
npx prisma db push
```
4. Delete all current users in your postrges database.
5. Delete your browser cookie manually.

> [!tip] **Verification**
> 1. Start your dev server
> ```bash
> npm run dev
> ```
> 2. Register a new account, once you click on register verify you get redirected to the unauthorized form.
> 3. Open you neon database and verify the sys_id of your record is uuid

## Customize your password hash algorithm
1. Install Argon2 algorithm for hashing.
```bash
npm install @node-rs/argon2
```
2. Update `next.config.ts` file to include argon2.
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  serverExternalPackages: ["@node-rs/argon2"],  //Add this line
};

export default nextConfig;
```
3. Go to `src/lib/` and create a new argon2 config file called `argon2.ts`.
```typescript
// argon2.ts
import { hash, verify, type Options } from "@node-rs/argon2";
const opts: Options = {
//Recommended minimum parameters
    memoryCost: 19456,
    timeCost: 2,
    outputLen: 32,
    parallelism: 1,
}
/***************   We export next two functions   ***************/
export async function hashPassword(password: string){
    const result = await hash(password, opts);
    return result
}
  
//Function is defined this way because this is the way better auth wants us to define hashing funcions
export async function verifyPassword(data: { password: string, hash: string}) {
    const { password, hash } = data;
    const result = await verify(hash, password, opts);
    return result;
}
```

> [!note] Lucia Auth recommended minimum parameters
> For a simple password-based auth, the password can just be stored in the user table.
>
>```typescript
>const passwordHash = await hash(password, {
>	// recommended minimum parameters
>	memoryCost: 19456,
>	timeCost: 2,
>	outputLen: 32,
>	parallelism: 1
>});
>const userId = generateIdFromEntropySize(10); // 16 characters long
>
>await db.table("user").insert({
>	id: userId,
>	email,
>	password_hash: passwordHash
>});
>```
> [Article](https://v3.lucia-auth.com/upgrade-v3/)

4. Go to `src/lib/auth.ts` and add the password property to emailAndPassword.
```typescript
import { hashPassword, verifyPassword } from "@/lib/argon2";

/***************************************************************/
emailAndPassword: {
	enabled: true,
	minPasswordLength: 6,
	autoSignIn: false,
	password: {
	  hash: hashPassword, // your custom password hashing function
	  verify: verifyPassword // your custom password verification function
	}
}
```

> [!tip] **Verification**
> 1. Start your dev server.
> ```bash
> npm run dev
> ```
> 2. Register an account.
> 3. Open your neon database
> 4. Go to accounts table and verify the password property is hashed with your hashing algorithm. (argo2 passwords look something like this: $argon2id$v=19$m=19456,t=2,p=1$)
## Sign Up User via Server Actions
> [!warning]
> We originally signed up & signed in using client, we are using the client instance of better auth and we did all the signing up/in on the client, **which is probably the recommended approach** but in this section we'll see how we can authenticate on the server side.
>
>We will refactor our sign up/in functions to be on server actions
### Sing up functionality
1. Go to `src` and create a folder called `actions` inside create a file called `sign-up-email.action.ts` 
```typescript
// src/actions/sign-up-email.action.ts
"use server"

import { auth } from "@/lib/auth";

export async function signUpEmailAction(formData: FormData) {
    const name = String(formData.get("name"));
    if (!name) return {error: "Name is required"}

    const email = String(formData.get("email"));
    if (!email) return {error: "Email is required"};

    const password = String(formData.get("password"));
    if (!password) return {error: "Password is required"};

    try {
        await auth.api.signUpEmail({
            body: {
                name,
                email,
                password
            }
        });
        return {error: null}
    } catch (err) {
        if (err instanceof Error) {
            return {error: "Oops! Something went wrong while registering"};
        }
        return {error: "Internal server error occurred"};
    }
}
```
2. Update `src/components/ui/register-form.tsx`
```typescript
// src/components/ui/register-form.tsx
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { useState } from "react";
import { useRouter } from "next/navigation";
import { signUpEmailAction } from "@/actions/sign-up-email.action";

export const RegisterForm = () => {
  const [isPending, setIsPending] = useState(false);
  const router = useRouter();

    async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
        evt.preventDefault();
        setIsPending(true);
        const formData = new FormData(evt.target as HTMLFormElement);
        const { error } = await signUpEmailAction(formData);
  
        if (error) {
          toast.error(error);
          setIsPending(false);
        }else{
          toast.success("Registration successful!");
          router.push("/auth/login");
        }
        setIsPending(false);
    }
// Return remain the same
```

> [!tip] **Validation**
> 1. Start your dev server
> ```bash
> npm run dev
> ```
> 2. Go to the register form.
> 3. Create a new user, while creating the user try entering a short password (less than 6 characters), confirm an error message is shown.
> 4. Create the user with allowed values and verify you get a confirmation toast message, and you get redirected to the login page.

## Sign In User via Server Actions
1. Go to `src/actions` create a file called `sign-in-email.action.ts` 
```typescript
// src/actions/sign-in-email.action.ts
"use server"

import { auth } from "@/lib/auth";

export async function signInEmailAction(formData: FormData) {

    const email = String(formData.get("email"));
    if (!email) return {error: "Email is required"};

    const password = String(formData.get("password"));
    if (!password) return {error: "Password is required"};

    try {
        const res = await auth.api.signInEmail({
            body: {
                email,
                password
            },
            asResponse: true
        });

        return {error: null}
    } catch (err) {
        if (err instanceof Error) {
            return {error: "Oops! Something went wrong while logging in"};
        }

        return {error: "Internal server error occurred"};
    }
}
```
2. Update `src/components/ui/login-form.tsx`
```typescript
// src/components/ui/login-form.tsx
"use client";

import React from "react";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { useRouter } from "next/navigation";
import { useState } from "react";
import { signInEmailAction } from "@/actions/sign-in-email.action";

export const LoginForm = () => {
  const [isPending, setIsPending] = useState(false)
  const router = useRouter();
  
  async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
      evt.preventDefault();
      setIsPending(true);
      const formData = new FormData(evt.target as HTMLFormElement);
      const { error } = await signInEmailAction(formData);

      if (error) {
        toast.error(error);
        setIsPending(false);
      }else{
        toast.success("Login successful!");
        router.push("/profile");
      }
    }
// Return remain the same
```

> [!tip] **Validation**
> 1. Start your dev server
> ```bash
> npm run dev
> ```
> 2. Go to the login form.
> 3. login with a wrong user, verify you get the error message you set in `sing-in-email` action as a toast.
> 4. login with an existing user, verify you get the success message you set in `login-form` as a toast and you get redirected to profile page. (you will see and unauthorized page)
## Set the cookie manually with email actions
> [!note]
> When you are working with server actions in nextjs you have to work with the cookies API to set the cookie, better auth has a plugin that does it for us, but before we use that we'll try to do it manually.

1. Go to `src/actions/sign-in-email.action.ts` and setup the cookie manually.
```typescript
// src/actions/sign-in-email.action.ts
"use server"

import { auth } from "@/lib/auth";
import { parseSetCookieHeader } from "better-auth/cookies";
import { cookies, headers } from "next/headers";

export async function signInEmailAction(formData: FormData) {
    const email = String(formData.get("email"));
    if (!email) return {error: "Email is required"};

    const password = String(formData.get("password"));
    if (!password) return {error: "Password is required"};

    try {
        const res = await auth.api.signInEmail({
	        headers: await headers(), // We pass the headers
            body: {
                email,
                password
            },
            asResponse: true
        });

        // setup cookie manually
        const setCookieHeader = res.headers.get("set-cookie"); // we grab the cookie from the header
        if (setCookieHeader){
            const cookie = parseSetCookieHeader(setCookieHeader); // we are parsing it and getting all the attributes
            const cookieStore = await cookies();
            
            // We format the cookie in the way that we need it
            const [key, cookieAttributes] = [...cookie.entries()][0];
            const value = cookieAttributes.value;
            const maxAge = cookieAttributes["max-age"];
            const path = cookieAttributes.path;
            const httpOnly = cookieAttributes.httpOnly;
            const sameSite = cookieAttributes.sameSite;

            // We set the cookie manually
            cookieStore.set(key, decodeURIComponent(value), {
                maxAge,
                path,
                httpOnly,
                sameSite
            });
        }
        // ===

        return {error: null}
    } catch (err) {
        if (err instanceof Error) {
            return {error: "Oops! Something went wrong while logging in"};
        }

        return {error: "Internal server error occurred"};
    }
}
```

> [!tip] **Validation**
> 1. Start your dev server
> ```bash
> npm run dev
> ```
> 2. Go to the login form.
> 3. login with an existing user, verify you get the success message you set in `login-form` as a toast and you get redirected to profile page. (this time you should see your user info)

## Set the cookie using Better auth function
> [!note]  
>[**Server Action Cookies**](https://www.better-auth.com/docs/integrations/next#server-action-cookies)
>
>When you call a function that needs to set cookies, like `signInEmail` or `signUpEmail` in a server action, cookies won’t be set. This is because server actions need to use the `cookies` helper from Next.js to set cookies.
>
>To simplify this, you can use the `nextCookies` plugin, which will automatically set cookies for you whenever a `Set-Cookie` header is present in the response.
>
>auth.ts
>
>```
>import { betterAuth } from "better-auth";
>import { nextCookies } from "better-auth/next-js";
>export const auth = betterAuth({
>    //...your config
>    plugins: [nextCookies()] // make sure this is the last plugin in the array
>})
>```
>
>Now, when you call functions that set cookies, they will be automatically set.
>
>```
>"use server";
>import { auth } from "@/lib/auth"
>const signIn = async () => {
>    await auth.api.signInEmail({
>        body: {
>            email: "user@email.com",
>            password: "password",
>        }
>    })
>}
>```
1. got to `src/lib/auth.ts` and import the nextCookies function.
```typescript
import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { nextCookies } from "better-auth/next-js" // import nextCookies package

import { prisma } from "@/lib/prisma";
import { hashPassword, verifyPassword } from "@/lib/argon2";

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  }),
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 6,
    autoSignIn: false,
    password: {
      hash: hashPassword, // your custom password hashing function
      verify: verifyPassword // your custom password verification function
    }
  },
  advanced: {
    database: {
      generateId: false,
    }
  },
  plugins: [nextCookies()], // add the nextCookies plugin
});
```

2. go to `sign-in-email.action.ts` and remove the manual cookie setup.
```typescript
"use server"

import { auth } from "@/lib/auth";
import { headers } from "next/headers";

export async function signInEmailAction(formData: FormData) {

    const email = String(formData.get("email"));
    if (!email) return {error: "Email is required"};
  
    const password = String(formData.get("password"));
    if (!password) return {error: "Password is required"};

    try {
        await auth.api.signInEmail({
            headers: await headers(), // we pass the headers
            body: {
                email,
                password
            },
        });

        return {error: null}
    } catch (err) {
        if (err instanceof Error) {
            return {error: "Oops! Something went wrong while logging in"};
        }
  
        return {error: "Internal server error occurred"};
    }
}
```

> [!tip] **Validation**
> 1. Start your dev server
> ```bash
> npm run dev
> ```
> 2. Go to the login form.
> 3. login with an existing user, verify you get the success message you set in `login-form` as a toast and you get redirected to profile page. (you should see your user info)

# Part III - Session, Middleware & Hooks
## Get the session on the client with Hooks
1. Go to `src/app/page.tsx` update to:
```typescript
import { GetStartedButton } from "@/components/ui/get-started-button";

export default function Page() {
  return (
    <div className="flex items-center justify-center h-dvh">
      <div className="flex justify-center gap-8 flex-col items-center">
        <h1 className="text-6xl font-bold">Better Authy</h1>
  
        <GetStartedButton />
      </div>
    </div>
  );
}
```
2. Go to `src/lib/auth-client.ts` and export the session.
```typescript
import { createAuthClient } from "better-auth/react"
import { auth } from "./auth"

export const authClient = createAuthClient({
    /** The base URL of the server (optional if you're using the same domain) */
    baseURL: process.env.NEXT_PUBLIC_API_URL,
})

export const {
    signUp,
    signOut,
    signIn,
    useSession // Add this line to export the session
} = authClient
```
2. Go to `src/components/ui` create a new file called `get-started-button.tsx`
```typescript
"use client";

import { useSession } from "@/lib/auth-client";
import { Button } from "@/components/ui/button";
import Link from "next/link";
  
export const GetStartedButton = () => {
  const { data: session, isPending } = useSession();

  if (isPending) {
    return (
      <Button size="lg" className="opacity-50">
        Get Started
      </Button>
    );
  }

  const href = session ? "/profile" : "/auth/login"; //if session active redirect to profile, else redirect to login screen
  
  //get Emoji from emojidb

  return (
    <div className="flex flex-col items-center gap-4">
      <Button size="lg" asChild>
        <Link href={href}>Get Started</Link>
      </Button>
      {session && <p>Welcome back, {session.user.name}! 👋</p>}
    </div>
  );
};
```
### Change session session.expiresIn property
1. Go to `src/lib/auth.ts` and add the session property.
```typescript
// add below emailAndPassword
session: {
    expiresIn: 30 * 24 * 60 * 60, // session expiration time in seconds
},
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Go to the home page (`/`).  
> 3. Verify that the **Get Started** button is visible in the center of the screen.  
> 4. If **no session** is active, clicking **Get Started** should redirect you to `/auth/login`.  
> 5. Log in with an existing user.  
> 6. After login, return to the home page (`/`).  
> 7. Verify that:  
>     - The **Get Started** button now redirects you to `/profile`.  
>     - A welcome message is displayed below the button:  
>       `Welcome back, <username>! 👋`  
> 8. Confirm that the session expiration (`expiresIn`) is set to **30 days** in `src/lib/auth.ts`.  
## Middleware
>[!note] 
>[**Middleware**](https://www.better-auth.com/docs/integrations/next#middleware)
>In Next.js middleware, it's recommended to only check for the existence of a session cookie to handle redirection. To avoid blocking requests by making API or database calls.
>[**Matcher**](https://nextjs.org/docs/app/api-reference/file-conventions/middleware#matcher)
The `matcher` option allows you to target specific paths for the Middleware to run on.

1. Go to `src/` and create a file called `middleware.ts`
```typescript
import { getSessionCookie } from "better-auth/cookies";
import { NextRequest, NextResponse } from "next/server";

// Define which routes should only be accessible by authenticated users
const protectedRoutes = ["/profile"]

export async function middleware(req: NextRequest) {
    const { nextUrl } = req;
    // Try to get the user's session cookie (null/undefined if not logged in)
    const sessionCookie = getSessionCookie(req);
  
    // Default response: allow the request to continue
    const res = NextResponse.next();

    // Flags for current request state
    const isLoggedIn = !!sessionCookie; // true if session cookie exists
    const isOnProtectedRoute = protectedRoutes.includes(nextUrl.pathname); // true if current path is in protectedRoutes
    const isOnAuthRoute = nextUrl.pathname.startsWith("/auth"); // true if user is on an auth page (login, signup, etc.)
  
    // 🚫 If user is trying to access a protected route but has no session -> redirect to login
    if (isOnProtectedRoute && !isLoggedIn) {
        return NextResponse.redirect(new URL("/auth/login", req.url));
    }

    // 🔄 If user is already logged in but tries to go to an auth route -> redirect to profile
    if (isOnAuthRoute && isLoggedIn) {
        return NextResponse.redirect(new URL("/profile", req.url));
    }

    // ✅ Otherwise, let the request pass through as normal
    return res;
}
  
// Middleware configuration: run for all routes except API, static files, and system assets
export const config = {
    matcher: [
        "/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)"
    ]
}
```
2. Go to `src/app/profile.tsx` and update the `if(!session)` result
```typescript
import { redirect } from "next/navigation";

if (!session) {
	return redirect("/auth/login");
}
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Go to `/profile` in your browser.  
>     - If **not logged in**, you should be redirected to `/auth/login`.  
> 3. Log in with an existing user.  
> 4. After login, try accessing `/auth/login` or any `/auth/...` route.  
>     - You should be redirected to `/profile`.  
> 5. Go back to `/profile`.  
>     - If logged in, the page should display your user profile (no redirect).  
> 6. Confirm that static assets and API routes still work (e.g., `/favicon.ico` should load, `/api/...` routes should respond normally).  
## Error Handling
1. Go to `src/actions/sign-up-email.action.ts` update the catch.
```typescript
import { APIError } from "better-auth/api";

catch (err) {
	if (err instanceof APIError) {
		const errCode = err.body ? (err.body.code as ErrorCode) : "UNKNOWN";
		switch (errCode) {
			case "USER_ALREADY_EXISTS":
				return {error: "Oops! something went wrong. Please try again"};
			default:
				return {error: err.message};
		}
	}
	return {error: "Internal server error occurred"};
}
```
2. Go to `arc/lib/auth.ts` and add at the end of the file:
```typescript
export type ErrorCode = keyof typeof auth.$ERROR_CODES | "UNKNOWN";
```
3. Go to `src/actions/sign-in-email.action.ts` update the catch.
```typescript
import { APIError } from "better-auth/api";

catch (err) {
	if (err instanceof APIError) {
		return {error: err.message};
	}
	return {error: "Internal server error occurred"};
}
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Go to your sign-up form.  
> 3. Try registering with an email that already exists in the database.  
>     - You should see the error message:  
>       **"Oops! something went wrong. Please try again"**  
> 4. Try registering with a new email.  
>     - You should be successfully signed up (no error message).  
> 5. Go to your sign-in form.  
> 6. Enter invalid credentials (wrong email/password).  
>     - You should see the error message returned from the API (`err.message`).  
## Hooks
> [!note]
>[ **Hooks**](https://www.better-auth.com/docs/concepts/hooks)
> Hooks in Better Auth let you "hook into" the lifecycle and execute custom logic. They provide a way to customize Better Auth's behavior without writing a full plugin.
### Create a hook to validate our email domain
1. Go to `src/lib/utils.ts` add the valid domains
```typescript
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

// Valid domains
export function getValidDomains() {
  const domains = ["gmail.com", "yahoo.com", "outlook.com"];

  if (process.env.NODE_ENV === "development") {
    domains.push("email.com");
  }
  return domains;
}
```
2. Go to `src/lib/auth.ts` and add the hooks between `emailAndPassword` and `session`.
```typescript
import { createAuthMiddleware, APIError } from "better-auth/api";
import { getValidDomains } from "@/lib/utils";

hooks: {
    before: createAuthMiddleware( async (ctx) => {
      if (ctx.path == "/sign-up/email"){
        const email = String(ctx.body.email);
        const domain = email.split("@")[1];
		const VALID_DOMAINS = getValidDomains();
        if (!VALID_DOMAINS.includes(domain)) {
          throw new APIError("BAD_REQUEST", {
            message: "Invalid email domain. Please use a valid email."
          });
        }
      }
    })
  },
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Go to the **sign-up form**.  
> 3. Try registering with an invalid email domain (e.g., `user@invalid.com`).  
>     - You should see the error message:  
>       **"Invalid email domain. Please use a valid email."**  
>     - The user should **not** be created.  
> 4. Try registering with a valid email domain (`gmail.com`, `yahoo.com`, or `outlook.com`).  
>     - The registration should succeed and the user should be created.  
> 5. In **development mode**, also test with `user@email.com`.  
>     - This should succeed (since `email.com` is added in dev).  
### Create a hook to normalize name
1. Go to `src/lib/utils.ts` add `normalizeName` function.
```typescript
export function normalizeName(name: string) {
  return name

    .trim()
    .replace(/\s+/g, " ")
    .replace(/[^a-zA-Z\s'-]/g, "")
    .replace(/\b\w/g, (char) => char.toUpperCase());
}
```
2. Add the auth function to `auth.ts` inside hooks
```typescript
hooks: {
    before: createAuthMiddleware( async (ctx) => {
      if (ctx.path == "/sign-up/email"){
        const email = String(ctx.body.email);
        const domain = email.split("@")[1];
        const VALID_DOMAINS = getValidDomains();
        
        if (!VALID_DOMAINS.includes(domain)) {
          throw new APIError("BAD_REQUEST", {
            message: "Invalid email domain. Please use a valid email."
          });
        }

        const name = normalizeName(ctx.body.name);
  
        return {
          context: {
            ...ctx,
            body: {
              ...ctx.body,
              name
            },
          },
        };
      }
    })
  },
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Go to the **sign-up form**.  
> 3. Register a user with extra spaces in the name (e.g., `   john   doe   `).  
>     - The saved name should be normalized to: **"John Doe"**.  
> 4. Register a user with invalid characters in the name (e.g., `m@ry!! sm1th`).  
>     - The saved name should be normalized to: **"Mry Smth"** (special characters and numbers removed).  
> 5. Register a user with mixed casing (e.g., `aLiCe o'coNnor`).  
>     - The saved name should be normalized to: **"Alice O'Connor"**.  
> 6. Confirm in the database or session that the normalized name is being stored correctly.  
# Part IV - Roles
## Role Management - Manually
1. Go to `prisma/schema.prisma`
```SQL
-- Add below datasource
enum UserRole {
  USER
  ADMIN
}

-- Update User table
model User {
  id        String   @id @default(uuid())
  createdAt DateTime
  updatedAt DateTime
  
  name          String
  email         String  @unique
  emailVerified Boolean
  image         String?
  role UserRole @default(USER)

  sessions Session[]
  accounts Account[]
  post     Post[]

  @@map("users")
}
```
2. Push the changes to our database
```bash
npx prisma db push
```
### Add role to our session object
1. Go to `src/lib/auth.ts` and add additional field to our user, add this above session.
```typescript
import { UserRole } from "@/generated/prisma";

user: {
	additionalFields: {
	  role: {
		type: ["USER", "ADMIN"] as Array<UserRole>,
		input: false,
	  },
	},
},
```
### Add role to our auth client instance 
1. Go to `src/lib/auth-client.ts` update to:
```typescript
import { createAuthClient } from "better-auth/react";
import { inferAdditionalFields } from "better-auth/client/plugins";
import type { auth } from "@/lib/auth";

export const authClient = createAuthClient({
  /** The base URL of the server (optional if you're using the same domain) */
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  plugins: [inferAdditionalFields<typeof auth>()],
});

export const { signUp, signOut, signIn, useSession } = authClient;
```
2. Go to `src/components/ui/get-started-button.tsx` update to display user role hint.
```typescript
// Update the return
return (
    <div className="flex flex-col items-center gap-4">
      <Button size="lg" asChild>
        <Link href={href}>Get Started</Link>
      </Button>
      {session && (
        <p className="flex items-center gap-2">
          <span
            data-role={session.user.role}
            className="size-4 rounded-full animate-pulse data-[role=USER]:bg-blue-600 data-[role=ADMIN]:bg-red-600"
          />
          Welcome back, {session.user.name}! 👋
        </p>
      )}
    </div>
  );
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Register a new user via the sign-up form.  
>     - By default, the user's `role` should be **USER**.  
> 3. Go to the database and verify the `role` field for the user is set correctly.  
> 4. Log in with the newly created user.  
>     - On the home page, under the **Get Started** button, you should see a colored indicator:  
>       - **Blue** pulse for `USER`  
>       - **Red** pulse for `ADMIN`  
> 5. Manually update a user in the database to have `role = ADMIN`.  
> 6. Log in as that user.  
>     - The role indicator should now appear **red**, confirming the `session.user.role` field is working correctly.  
> 7. Confirm that `session.user.role` is accessible in your components via the `useSession()` hook.  
## Create an admin panel
1. Go to `src/app/` and create a new folder called `admin`, create a `dashboard` folder inside admin folder, and a `page.tsx` file inside dashboard
```typescript
import { ReturnButton } from "@/components/ui/return-button";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { headers } from "next/headers";
import { redirect } from "next/navigation";
  
export default async function Page() {
  // grab our session
  const session = await auth.api.getSession({
    headers: await headers(),
  });
  
  if (!session) redirect("/auth/login");
  
  if (session.user.role !== "ADMIN") {
    return (
      <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
        <div className="space-y-8">
          <ReturnButton href="/profile" label="Back to Profile" />
  
          <h1 className="text-3xl font-bold">Admin Dashboard</h1>
          <p className="p-2 rounded-md text-lg bg-red-600 text-white font-bold">
            You do not have permission to view this page.
          </p>
        </div>
      </div>
    );
  }

  
  const users = await prisma.user.findMany({
    orderBy: {
      name: "asc",
    },
  });

  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/profile" label="Back to Profile" />

        <h1 className="text-3xl font-bold">Admin Dashboard</h1>
  
        <p className="p-2 rounded-md text-lg bg-green-600 text-white font-bold">
          Welcome, {session.user.name}! You have admin access.
        </p>
      </div>
      <div className="w-full overflow-x-auto">
        <table className="table-auto min-w-full whitespace-nowrap">
          <thead>
            <tr>
              <th className="px-4 py-2">ID</th>
              <th className="px-4 py-2">Name</th>
              <th className="px-4 py-2">Email</th>
              <th className="px-4 py-2 text-center">Role</th>
              <th className="px-4 py-2 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {users.map((user) => (
              <tr key={user.id}>
                <td className="border px-4 py-2">{user.id.slice(0, 8)}</td>
                <td className="border px-4 py-2">{user.name}</td>
                <td className="border px-4 py-2">{user.email}</td>
                <td className="border px-4 py-2 text-center">{user.role}</td>
                <td className="border px-4 py-2 text-center">DELETE</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
```
1. Go to `src/middleware` and protect the admin page.
```typescript
const protectedRoutes = ["/profile", "/admin/dashboard"];
```
### Create a link to the admin dashboard page
1. Go to `src/app/profile/page.tsx` add a link to the admin dashboard page above the sign out button.
```typescript
import { SignOutButton } from "@/components/sign-out-button";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { ReturnButton } from "@/components/ui/return-button";
import { redirect } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Link } from "lucide-react";

export default async function Page() {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session) {
    return redirect("/auth/login");
  }

  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Profile</h1>
      </div>

      <div className="flex items-center gap-2">
        {session.user.role === "ADMIN"(
          <Button size="sm" asChild>
            <Link href="/admin/dashboard">Admin Dashboard</Link>
          </Button>
        )}
        <SignOutButton />
      </div>
  
      <pre className="text-sm overflow-clip">
        {JSON.stringify(session, null, 2)}
      </pre>
    </div>
  );
}
```
### Add a delete user action
1. Go to `src/components/` and create a new file called `delete-user-button.tsx`
```typescript
"use client";

import { TrashIcon } from "lucide-react";
import { Button } from "./ui/button";
import { useState } from "react";
import { toast } from "sonner";
import { deleteUserAction } from "@/actions/delete-user.action";

// Props definition for DeleteUserButton component
interface DeleteUserButtonProps {
  userId: string; // The ID of the user to be deleted
}

export const DeleteUserButton = ({ userId }: DeleteUserButtonProps) => {
  const [isPending, setIsPending] = useState(false);
  // Tracks whether the delete action is currently running (used to disable the button)
  
  // Handles the delete action when button is clicked
  async function handleClick() {
    setIsPending(true); // Disable button while request is in progress

    const { error } = await deleteUserAction({ userId });
    // Call the server action to delete the user

    if (error) {
      toast.error(error); // Show error toast if deletion failed
    } else {
      toast.success("User deleted Successfully!"); // Success toast on completion
    }

    setIsPending(false); // Re-enable button after request finishes
  }

  return (
    <Button
      onClick={handleClick} // Trigger delete on click
      size="icon"
      variant="destructive"
      className="size-7 rounded-sm"
      disabled={isPending}
    >
      <span className="sr-only">Delete User</span>
      <TrashIcon />
    </Button>
  );
};

export const PlaceHolderDeleteUserButton = () => {
  return (
    <Button
      size="icon"
      variant="destructive"
      className="size-7 rounded-sm"
      disabled
    >
      <span className="sr-only">Delete User</span>
      <TrashIcon />
    </Button>
  );
};
```
2. Import button into `src/app/admin/dashboard/page.tsx`
```typescript
<tbody>
	{users.map((user) => (
	  <tr key={user.id}>
		<td className="border px-4 py-2">{user.id.slice(0, 8)}</td>
		<td className="border px-4 py-2">{user.name}</td>
		<td className="border px-4 py-2">{user.email}</td>
		<td className="border px-4 py-2 text-center">{user.role}</td>
		<td className="border px-4 py-2 text-center">
		  {user.role === "USER" ? (
			<DeleteUserButton userId={user.id} />
		  ) : (
			<PlaceHolderDeleteUserButton />
		  )}
		</td>
	  </tr>
	))}
</tbody>
```
3. Go to `src/actions/` and create a file called `delete-user.action.ts`
```typescript
"use server";

import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { isRedirectError } from "next/dist/client/components/redirect-error";
import { headers } from "next/headers";
import { redirect } from "next/navigation";

export async function deleteUserAction({ userId }: { userId: string }) {
  // 🔹 Get request headers (needed for auth and API calls)
  const headersList = await headers();

  // 🔹 Retrieve the current session from the authentication system
  const session = await auth.api.getSession({
    headers: headersList,
  });

  // 🔹 If no session exists → user is not logged in
  if (!session) {
    throw new Error("You must be logged in to delete a user.");
  }

  // 🔹 Only allow ADMINs to delete users
  if (session.user.role !== "ADMIN") {
    throw new Error("FORBIDDEN");
  }

  try {
    // 🔹 Delete user from the database, but only if the user has role USER
    await prisma.user.delete({
      where: {
        id: userId,
        role: "USER", // prevents deleting other admins
      },
    });

    // 🔹 If the admin deletes their own account → sign them out
    if (session.user.id === userId) {
      await auth.api.signOut({
        headers: headersList,
      });
      redirect("/auth/sign-in"); // force redirect to sign-in page
    }

    // 🔹 Revalidate the admin dashboard so the deleted user no longer shows up
    revalidatePath("/admin/dashboard");

    // 🔹 Return success response (no error)
    return { error: null };
  } catch (err) {
    // 🔹 Handle special redirect errors (must be re-thrown to work correctly)
    if (isRedirectError(err)) {
      throw err;
    }

    // 🔹 If it's a known error → return message
    if (err instanceof Error) {
      return { error: err.message };
    }

    // 🔹 Fallback for unexpected errors
    return { error: "UNKNOWN_ERROR" };
  }
}
```

> [!note]
> [**Handling exceptions and errors in prisma**](https://www.prisma.io/docs/orm/prisma-client/debugging-and-troubleshooting/handling-exceptions-and-errors)
>In order to handle different types of errors you can use `instanceof` to check what the error is and handle it accordingly.
>
>The following example tries to create a user with an already existing email record. This will throw an error because the `email` field has the `@unique` attribute applied to it.
>
>schema.prisma
>```SQL
>model User {  
>  id    Int     @id @default(autoincrement())  
>  email String  @unique  
>  name  String?
>}
>```
>Use the `Prisma` namespace to access the error type. The [error code](https://www.prisma.io/docs/orm/reference/error-reference#error-codes) can then be checked and a message can be printed.
>```typescript
>import { PrismaClient, Prisma } from '@prisma/client'
>const client = new PrismaClient()
>try {
>  await client.user.create({ data: { email: 'alreadyexisting@mail.com' } })
>} catch (e) {
>  if (e instanceof Prisma.PrismaClientKnownRequestError) {
>    // The .code property can be accessed in a type-safe manner
>    if (e.code === 'P2002') {
>      console.log(
>        'There is a unique constraint violation, a new user cannot be created with this email'
>      )
>    }
>  }
>  throw e
>  }
>```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Log in as an **ADMIN** and navigate to `/admin/dashboard`.  
>     - A **trash icon button** should appear next to users with role `USER`.  
>     - For other admins (including your own account), you should see the **placeholder button** instead.  
> 3. As an **ADMIN**, delete a user with role `USER`.  
>     - A **success toast** should appear.  
>     - The user should be removed from the table immediately.  
>     - Verify in your database that the record is deleted.
### Database Hooks
#### Make specific users admin upon account creation
1. Go to `src/lib/auth.ts` under hooks, add:
```typescript
// Check if you should be an admin and set your role to admin
databaseHooks: {
    user: {
      create: {
        before: async (user) => {
          const ADMIN_EMAILS = process.env.ADMIN_EMAILS?.split(";") || [];
  
          if (ADMIN_EMAILS.includes(user.email)) {
            return { data: { ...user, role: UserRole.ADMIN } }; // set role to ADMIN if email is in the list
          }

          return { data: user };
        },
      },
    },
  },
```
2. Create an environment variable for ADMIN_EMAIL, go to `.env`
```typescript
ADMIN_EMAILS="mauro@email.com;mauro.duque@email.com;testing@email.com;admin@email.com"
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Register a new user with an email from `ADMIN_EMAILS`.  
>     - Example: `mauro@email.com`  
>     - Verify in your database that the user’s `role` is set to **ADMIN**.  
> 3. Register a new user with an email **not** listed in `ADMIN_EMAILS`.  
>     - Example: `random@email.com`  
>     - Verify in your database that the user’s `role` remains **USER** (or your default role).  

## Role Management - Better Auth Admin Plugin
>[!note]
>[** Better Auth Admin Plugin**](https://www.better-auth.com/docs/plugins/admin)
>The Admin plugin provides a set of administrative functions for user management in your application. It allows administrators to perform various operations such as creating users, managing user roles, banning/unbanning users, impersonating users, and more.
>
> [**Schema**](https://www.better-auth.com/docs/plugins/admin#schema)
>
This plugin adds the following fields to the `user` table:
>
>| Field Name | Type    | Key | Description                                                             |
| ---------- | ------- | --- | ----------------------------------------------------------------------- |
| role       | string  | ?   | The user's role. Defaults to `user`. Admins will have the `admin` role. |
| banned     | boolean | ?   | Indicates whether the user is banned.                                   |
| banReason  | string  | ?   | The reason for the user's ban.                                          |
| banExpires | date    | ?   | The date when the user's ban will expire.                               |
>
And adds one field in the `session` table:
>
>| Field Name     | Type   | Key | Description                                             |
| -------------- | ------ | --- | ------------------------------------------------------- |
| impersonatedBy | string | ?   | The ID of the admin that is impersonating this session. |

1. Go to `src/lib/auth.ts`
```typescript
// import the plugin
import { admin } from "better-auth/plugins"

// add the plugin
plugins: [
    nextCookies(),
    admin({
      defaultRole: UserRole.USER, // default role for new users
      adminRoles: [UserRole.ADMIN]
    })
  ],
```
2. Generate database to add the extra field for admin plugin
```bash
npx @better-auth/cli generate --output=roles.schema.prisma
```
3. Go to the file we generated `roles.schema.prisma` and copy the fields into our schema.
4. Go to `prisma/schema.prisma` add the changes.
```SQL
--User table
model User {
  id        String   @id @default(uuid())
  createdAt DateTime
  updatedAt DateTime
  
  name          String
  email         String   @unique
  emailVerified Boolean
  image         String?
  role          UserRole @default(USER)
  banned        Boolean? --New field
  banReason     String? --New field
  banExpires    DateTime? --New field

  sessions Session[]
  accounts Account[]
  posts    Post[]
  
  @@map("users")
}

-- Session table

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime
  updatedAt DateTime

  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  impersonatedBy String? --New field

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}
```
5.  Once you added the changes you need to push the changes to the database
```bash
npx prisma db push
```
6. After you add the changes delete the prisma schema you created from where you copied the changes.

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Register a new user.  
>     - In your database, verify that the new user has:  
>       - `role` set to **USER** (default).  
>       - `banned`, `banReason`, and `banExpires` set to **null/false** by default.  

### Add permissions using better auth plugin
1. Go to `src/lib/` and create a new file called `permissions.ts`.
```typescript
import { UserRole } from "@/generated/prisma";
import { createAccessControl } from "better-auth/plugins/access";
import { defaultStatements, adminAc } from "better-auth/plugins/admin/access";

const statements = {
  ...defaultStatements,
  posts: ["read", "create", "update", "delete", "update:own", "delete:own"],
} as const;
  
export const ac = createAccessControl(statements);

export const roles = {
  [UserRole.USER]: ac.newRole({
    posts: ["read", "create", "update:own", "delete:own"],
  }),
  [UserRole.ADMIN]: ac.newRole({
    ...adminAc.statements,
    posts: ["read", "create", "update", "delete", "update:own", "delete:own"],
  }),
};
```
2. Import roles into `src/lib/auth.ts`
```typescript
// import roles
import { ac, roles } from "@/lib/permissions"

//update plugin
plugins: [
	nextCookies(),
	admin({
	  defaultRole: UserRole.USER, // default role for new users
	  adminRoles: [UserRole.ADMIN],
	  ac,
	  roles,
	}),
],
```
3. Add roles into `src/lib/auth-client.ts`
```typescript
import { createAuthClient } from "better-auth/react";
import { inferAdditionalFields, adminClient } from "better-auth/client/plugins";
import type { auth } from "@/lib/auth";
import { ac, roles } from "@/lib/permissions";

export const authClient = createAuthClient({
  /** The base URL of the server (optional if you're using the same domain) */
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  plugins: [inferAdditionalFields<typeof auth>(), adminClient({ ac, roles })],
});
  
export const { signUp, signOut, signIn, useSession } = authClient;
```
### Stop prisma query and use better auth API to sort user table
1. Go to `src/app/admin/dashboard/page.tsx` update to:
```typescript
import {
  DeleteUserButton,
  PlaceHolderDeleteUserButton,
} from "@/components/delete-user-button";
import { ReturnButton } from "@/components/ui/return-button";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { redirect } from "next/navigation";

export default async function Page() {
  const headerList = await headers();

  // Get the current session from the request headers
  const session = await auth.api.getSession({
    headers: headerList,
  });

  // If no session exists, redirect user to the login page
  if (!session) redirect("/auth/login");

  // If the logged-in user is not an admin, show an error message and stop here
  if (session.user.role !== "ADMIN") {
    return (
      <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
        <div className="space-y-8">
          {/* Back button to return to profile */}
          <ReturnButton href="/profile" label="Back to Profile" />

          {/* Page title */}
          <h1 className="text-3xl font-bold">Admin Dashboard</h1>

          {/* Error message shown when user has no admin permissions */}
          <p className="p-2 rounded-md text-lg bg-red-600 text-white font-bold">
            You do not have permission to view this page.
          </p>
        </div>
      </div>
    );
  }

  // If the user is an admin, fetch all users
  const { users } = await auth.api.listUsers({
    headers: headerList,
    query: {
      sortBy: "name",
    },
  });
  
  // Sort users so admins appear first
  const sortedUsers = users.sort((a, b) => {
    if (a.role === "ADMIN" && b.role !== "ADMIN") return -1;
    if (a.role !== "ADMIN" && b.role === "ADMIN") return 1;
    return 0;
  });

  
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        {/* Back button to return to profile */}
        <ReturnButton href="/profile" label="Back to Profile" />
  
        {/* Page title */}
        <h1 className="text-3xl font-bold">Admin Dashboard</h1>
  
        {/* Success message shown when user has admin access */}
        <p className="p-2 rounded-md text-lg bg-green-600 text-white font-bold">
          Welcome, {session.user.name}! You have admin access.
        </p>
      </div>
  
      {/* Users table */}
      <div className="w-full overflow-x-auto">
        <table className="table-auto min-w-full whitespace-nowrap">
          <thead>
            <tr>
              <th className="px-4 py-2">ID</th>
              <th className="px-4 py-2">Name</th>
              <th className="px-4 py-2">Email</th>
              <th className="px-4 py-2 text-center">Role</th>
              <th className="px-4 py-2 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {/* Render each user in a table row */}
            {sortedUsers.map((user) => (
              <tr key={user.id}>
                {/* Shortened ID (first 8 chars only) */}
                <td className="border px-4 py-2">{user.id.slice(0, 8)}</td>

                {/* User details */}
                <td className="border px-4 py-2">{user.name}</td>
                <td className="border px-4 py-2">{user.email}</td>
                <td className="border px-4 py-2 text-center">{user.role}</td>
  
                {/* Show delete button only for USER role, otherwise show placeholder */}
                <td className="border px-4 py-2 text-center">
                  {user.role === "USER" ? (
                    <DeleteUserButton userId={user.id} />
                  ) : (
                    <PlaceHolderDeleteUserButton />
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Log in as an **ADMIN** and navigate to `/admin/dashboard`.  
> 3. Verify the users table:  
>     - Users with role `ADMIN` should appear at the **top of the list**.  
>     - Users with role `USER` should appear **below admins**.  
> 4. Add a new user with role `ADMIN` and refresh the page.  
>     - Confirm that the new admin appears at the **top**, maintaining correct sort order.  
> 5. Add a new user with role `USER` and refresh the page.  
>     - Confirm that the new user appears **below all admins**, maintaining correct sort order.  
### Update delete user action prisma query to use admin api
1. Go to `src/actions/delete-user.action.ts` 
TBD
### Make use of newly created roles
1. Go to `src/app/profile/page.tdx`
```typescript
import { SignOutButton } from "@/components/sign-out-button";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { ReturnButton } from "@/components/ui/return-button";
import { redirect } from "next/navigation";
import { Button } from "@/components/ui/button";
import Link from "next/link";
  
export default async function Page() {
  const headerList = await headers();

  const session = await auth.api.getSession({
    headers: headerList,
  });

  if (!session) {
    return redirect("/auth/login");
  }

  const FULL_POST_ACCESS = await auth.api.userHasPermission({
    headers: headerList,
    body: {
      permissions: {
        posts: ["update", "delete"],
      },
    },
  });

  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Profile</h1>
      </div>

      <div className="flex items-center gap-2">
        {session.user.role === "ADMIN" && (
          <Button size="sm" asChild>
            <Link href="/admin/dashboard">Admin Dashboard</Link>
          </Button>
        )}
        <SignOutButton />
      </div>

      <div className="text-2xl font-bold">Permissions </div>
      <div className="space-x-4">
        <Button size="sm">MANAGE OWN POSTS</Button>
        <Button size="sm" disabled={!FULL_POST_ACCESS.success}>
          MANAGE ALL POSTS
        </Button>
      </div>
      <pre className="text-sm overflow-clip">
        {JSON.stringify(session, null, 2)}
      </pre>
    </div>
  );
}
```
### Create a dropdown menu for our roles
1. Go to `src/components/user-role-select.tsx`
```typescript
"use client";

import { UserRole } from "@/generated/prisma";
import { admin } from "@/lib/auth-client";
import { useRouter } from "next/navigation";
import { useState } from "react";
import { toast } from "sonner";
  
interface UserRoleSelectProps {
  userId: string;
  role: UserRole;
}

export const UserRoleSelect = ({ userId, role }: UserRoleSelectProps) => {
  const [isPending, setIsPending] = useState(false);
  const router = useRouter();
  
  async function handleChange(evt: React.ChangeEvent<HTMLSelectElement>) {
    const newRole = evt.target.value as UserRole;
  
    const canChangeRole = await admin.hasPermission({
      permissions: {
        user: ["set-role"],
      },
    });

    if (canChangeRole.error) {
      return toast.error("You do not have permission to change user roles.");
    }
  
    await admin.setRole({
      userId,
      role: newRole,
      fetchOptions: {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error("Failed to update user role.");
        },
        onSuccess: () => {
          toast.success("User role updated successfully.");
          router.refresh();
        },
      },
    });
  }
  
  return (
    <select
      value={role}
      onChange={handleChange}
      disabled={role === UserRole.ADMIN || isPending}
      className="px-3 py-2 text-sm disabled:cursor-not-allowed disabled:opacity-50"
    >
      <option value={UserRole.USER}>User</option>
      <option value={UserRole.ADMIN}>Admin</option>
    </select>
  );
};
```
2. Import select into admin dashboard `src/app/admin/dashboard/page.tsx`.
```typescript
<tbody>
	{/* Render each user in a table row */}
	{sortedUsers.map((user) => (
	  <tr key={user.id}>
		{/* Shortened ID (first 8 chars only) */}
		<td className="border px-4 py-2">{user.id.slice(0, 8)}</td>
		{/* User details */}
		<td className="border px-4 py-2">{user.name}</td>
		<td className="border px-4 py-2">{user.email}</td>
		<td className="border px-4 py-2 text-center">
		  <UserRoleSelect
			userId={user.id}
			role={user.role as UserRole}
		  />
		</td>
		{/* Show delete button only for USER role, otherwise show placeholder */}
		<td className="border px-4 py-2 text-center">
		  {user.role === "USER" ? (
			<DeleteUserButton userId={user.id} />
		  ) : (
			<PlaceHolderDeleteUserButton />
		  )}
		</td>
	  </tr>
	))}
</tbody>
```
3. Go to `src/lib/auth-client.ts` and export admin.
```typescript
export const { signUp, signOut, signIn, useSession, admin } = authClient;
```
# Part V - Socials Auth
## Setup Google & GitHub authentication
1. Go to `src/components/ui` and create a file called `sign-in-oauth-button.tsx`
```typescript
"use client";
  
import React, { useState } from "react";
import { Button } from "@/components/ui/button";

interface SignInOAuthButtonProps {
  provider: "google" | "github";
  signUp?: boolean;
}

export const SignInOAuthButton = ({
  provider,
  signUp,
}: SignInOAuthButtonProps) => {

  const [isPending, setIsPending] = useState(false);

  async function handleClick() {}
  
  const action = signUp ? "Up" : "In";
  const providerName = provider === "google" ? "Google" : "GitHub";
  
  return (
    <Button onClick={handleClick} disabled={isPending}>
      Sign {action} with {providerName}
    </Button>
  );
};
```
2. Go to `src/app/auth/login/page.tsx` and add the button component.
```typescript
import { LoginForm } from "@/components/ui/login-form";
import { ReturnButton } from "@/components/ui/return-button";
import { SignInOAuthButton } from "@/components/ui/sign-in-oauth-button";
import Link from "next/link";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/" label="Back to Home" />
        <h1 className="text-3xl font-bold">Login</h1>
      </div>

      <div className="text-muted-foreground test-sm">
        <LoginForm />
        <p className="text-muted-foreground text-sm">
          Don't have an account?{" "}
          <Link href="/auth/register" className="text-blue-600 hover:underline">
            Register
          </Link>
        </p>
        
        <hr className="max-w-sm" />
      </div>

      <div className="flex flex-col max-w-sm gap-4">
        <SignInOAuthButton provider="google" />
        <SignInOAuthButton provider="github" />
      </div>
    </div>
  );
}
```
3. Go to `src/app/auth/register/page.tsx` and add the button component.
```typescript
import { RegisterForm } from "@/components/ui/register-form";
import { ReturnButton } from "@/components/ui/return-button";
import { SignInOAuthButton } from "@/components/ui/sign-in-oauth-button";
import Link from "next/link";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Register</h1>
      </div>

      <div className="text-muted-foreground test-sm">
        <RegisterForm />
        <p className="text-muted-foreground text-sm">
          Already have an account?{" "}
          <Link href="/auth/login" className="text-blue-600 hover:underline">
            Login
          </Link>
        </p>
        
        <hr className="max-w-sm" />
      </div>
  
      <div className="flex flex-col max-w-sm gap-4">
        <SignInOAuthButton provider="google" />
        <SignInOAuthButton provider="github" />
      </div>
    </div>
  );
}
```
### Setup Google credentials
>[!note]
>[**Get your Google credentials**](https://www.better-auth.com/docs/authentication/google#get-your-google-credentials)
>
To use Google as a social provider, you need to get your Google credentials. You can get them by creating a new project in the [Google Cloud Console](https://console.cloud.google.com/apis/dashboard).
>
In the Google Cloud Console > Credentials > Authorized redirect URIs, make sure to set the redirect URL to `http://localhost:3000/api/auth/callback/google` for local development. For production, make sure to set the redirect URL as your application domain, e.g. `https://example.com/api/auth/callback/google`. If you change the base path of the auth routes, you should update the redirect URL accordingly.
1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/dashboard).
2. Go to Credentials.
3. Create a new project, name it `login-app`.
4. Go to OAuth consent screen under API & Services.
5. Click on Get Started, and fill the form and select create.
6. Go back to API & Services.
7. Select Credentials
8. Click on +Create Credentials, Select OAuth Client ID.
9. Application type select web application.
10. Set the name to `login-app`
11. Authorized JavaScript origins: http://localhost:3000
12. Authorized redirect URIs: http://localhost:3000/api/auth/callback/google
13. Click create.
14. Copy client ID and Client Secret.
15. Go to `.env`
```typescript
BETTER_AUTH_SECRET="your-betther-auth-secret"
BETTER_AUTH_URL="http://localhost:3000" #Base URL of your app

NEXT_PUBLIC_API_URL="http://localhost:3000"

DATABASE_URL="your-DB-URL"

ADMIN_EMAILS="mauro@email.com;mauro.duque@email.com;testing@email.com;admin@email.com"

GOOGLE_CLIENT_ID="your-google-client-id"

GOOGLE_CLIENT_SECRET="your-google-client-secret"
```
16. Click on accept.
17. Go to `src/lib/auth.ts` under `database:` and enable OAuth in better auth options.
```typescript
socialProviders: {
    google: {
      clientId: String(process.env.GOOGLE_CLIENT_ID),
      clientSecret: String(process.env.GOOGLE_CLIENT_SECRET),
    },
  },
```
#### Configure google auth button
1. Go to `src/components/ui/sign-in-oauth-button.tsx` and update the handleClick function.
```typescript
import { signIn } from "@/lib/auth-client";
import { toast } from "sonner";

async function handleClick() {
    await signIn.social({
      provider,
      callbackURL: "/profile",
      errorCallbackURL: "/auth/login/error",
      fetchOptions: {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error(ctx.error.message);
        },
      },
    });
  }
```
### Setup GitHub credentials
> [!note]
> [**Get your GitHub credentials**](https://www.better-auth.com/docs/authentication/github#get-your-github-credentials)
>
To use GitHub sign in, you need a client ID and client secret. You can get them from the [GitHub Developer Portal](https://github.com/settings/developers).
>
Make sure to set the redirect URL to `http://localhost:3000/api/auth/callback/github` for local development. For production, you should set it to the URL of your application. If you change the base path of the auth routes, you should update the redirect URL accordingly.
>
Important: You MUST include the user:email scope in your GitHub app. See details below.
1. Go to [GitHub Developer Portal](https://github.com/settings/developers).
2. Create a new OAuth app.
3. Set the name to `login-app`, Homepage URL to `http://localhost:3000`, Authorization callback URL: `http://localhost:3000/api/auth/callback/github`.
4. click on register application.
5. Copy client ID & client secret, and add to your `.env` file.
```typescript
GITHUB_CLIENT_ID="your client ID"

GITHUB_CLIENT_SECRET="your client secret"
```
6. Add your social provider to `auth.ts`
```typescript
github: {
  clientId: String(process.env.GITHUB_CLIENT_ID),
  clientSecret: String(process.env.GITHUB_CLIENT_SECRET),
},
```

> [!tip] **Validation**  
> 1. Start your dev server  
> ```bash
> npm run dev
> ```  
> 2. Go to **http://localhost:3000/auth/login** in your browser.  
> 3. Click **"Sign In with Google"**.  
>     - You should be redirected to the Google sign-in page.  
>     - After logging in, you should be redirected back to `/profile`.  
>     - Verify that your user record is created in the database with the provider set to **google**.  
> 4. Log out and go back to the login page.  
> 5. Click **"Sign In with GitHub"**.  
>     - You should be redirected to GitHub’s OAuth screen.  
>     - After authorization, confirm you are redirected back to `/profile`.  
>     - Verify that your user record in the database shows the provider set to **github**.  
> 6. Go to `/auth/register` and repeat steps **3–5** to confirm the buttons also work in the registration flow.  
> 7. Test error handling:  
>     - Temporarily revoke app permissions from your Google/GitHub account.  
>     - Attempt to sign in again and confirm that an **error toast** is displayed.  
## Account Linking
>[!note]
>1. Truncate neon database.
>2. sign up with your gmail and github accounts, and then create a user with the same email.
>3. Confirm 3 different account records were created for the same user.
>
>**This is called account linking and better auth does it for us automatically.**
### Disable account linking
1. Go to `src/lib/auth.ts` add account linking below session.
```typescript
account: {
	accountLinking: {
	  enabled: false,
	},
},
```

> [!tip] **Verification**  
> 1. Start your dev server.  
> ```bash
> npm run dev
> ```  
> 2. Truncate your neon database.
> 3. Create a new user manually with the same email as your Gmail account.
> 4. Try to sing in with your Gmail account.
> 5. you should be redirected to a 404 error page.
### Create a custom error page
1. Go to `src/app/auth/login` create a new folder called `error` inside error create a new file called `page.tsx`.
```typescript
import { ReturnButton } from "@/components/ui/return-button";

interface PageProps {
  searchParams: Promise<{ error: string }>;
}

export default async function Page({ searchParams }: PageProps) {
  const sp = await searchParams;
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Login Error</h1>
      </div>

      <p className="text-destructive">
        {sp.error == "account_not_linked"
          ? "Your account is not linked. Please link your account."
          : "An unknown error occurred."}
      </p>
    </div>
  );
}
```
# Part VI - Email Verification, Forgot Password, Reset Password
## Install nodemailer
```bash
npm install nodemailer
npm install @types/nodemailer --save-dev
```
## Setup nodemailer
1. Go to `src/lib` create a new file called `nodemailer.ts`
```typescript
import nodemailer from "nodemailer";

const transporter = nodemailer.createTransport({
  host: "smtp.gmail.com",
  port: 465,
  secure: true,
  auth: {
    user: process.env.NODEMAILER_USER,
    pass: process.env.NODEMAILER_APP_PASSWORD,
  },
});

export default transporter;
```
2. Go to `.env`
```typescript
NODEMAILER_USER="your_email@gmail.com" //Your gmail

NODEMAILER_APP_PASSWORD="your_app_password" //we will create this app password later
```
### Setup app passwords with google
>[!note]
>**Sign in with app passwords**
>**mportant:** App passwords aren't recommended and are unnecessary in most cases. To help keep your account secure, use "Sign in with Google" to connect apps to your Google Account.
>
>An app password is a 16-digit passcode that gives a less secure app or device permission to access your Google Account. App passwords can only be used with accounts that have [2-Step Verification](https://support.google.com/accounts/answer/185839) turned on.
>
>**Create & use app passwords**
>
>**Important:** To create an app password, you need 2-Step Verification on your Google Account.
>
>If you use 2-Step-Verification and get a "password incorrect" error when you sign in, you can try to use an app password.
>
>[Create and manage your app passwords](https://myaccount.google.com/apppasswords). You may need to sign in to your Google Account.
>
>If you've set up 2-Step Verification but can't find the option to add an app password, it might be because:
>
>- Your Google Account has 2-Step Verification [set up only for security keys](https://support.google.com/accounts/answer/6103523).
>- You're logged into a work, school, or another organization account.
>- Your Google Account has [Advanced Protection](https://support.google.com/accounts/answer/7539956).
>
>**Tip:** Usually, you'll need to enter an app password once per app or device.
1. Go to [Create and manage your app passwords](https://myaccount.google.com/apppasswords).
2. Select the name of the app `login-app`.
3. Copy your app password and paste it into your `.env` file.
## Setup a server action to send emails
1. Go to `src/actions` and create a new file called `send-email.action.ts`
```typescript
"use server";
  
import transporter from "@/lib/nodemailer";
import { success } from "better-auth";
import { BiParagraph } from "react-icons/bi";
  
const styles = {
  container:
    "max-width:500px;margin:20px auto;padding:20px;border:1px solid #eee;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.1);",
  heading: "font-size:20px;color:#333;",
  paragraph: "font-size:16px;color:#666;line-height:1.5;",
  link: "display:inline-block;margin-top:15px;padding:10px 15px;background-color:#007bff;color:#fff;border-radius:5px;text-decoration:none;",
};

export async function sendEmailAction({
  to,
  subject,
  meta,
}: {
  to: string;
  subject: string;
  meta: {
    description: string;
    link: string;
  };
}) {
  const mailOptions = {
    from: process.env.NODEMAILER_USER,
    to,
    subject: `BetterAuthy - ${subject}`,
    html: `
          <div style="${styles.container}">
            <h1 style="${styles.heading}">${subject}</h1>
            <p style="${styles.paragraph}">${meta.description}</p>
            <a href="${meta.link}" style="${styles.link}">Click here</a>
          </div>
        `,
  };
  
  try {
    await transporter.sendMail(mailOptions);
    return { success: true };
  } catch (err) {
    console.log("Error sending email:", err);
    return { success: false };
  }
}
```
2. Go to `src/lib/auth.ts` inside emailAndPassword add the requiredEmailVerification property.
```typescript
emailAndPassword: {
    enabled: true,
    minPasswordLength: 6,
    autoSignIn: false,
    password: {
      hash: hashPassword, // your custom password hashing function
      verify: verifyPassword, // your custom password verification function
    },
    requireEmailVerification: true,
  },
```
## Setup Email
1. Go to `src/lib/auth.ts` under emailAndPassword add emailVerification property.
```typescript
import { sendEmailAction } from "@/actions/send-email.action";

emailVerification: {
    sendOnSignUp: true,
    expiresIn: 60 * 60,
    autoSignInAfterVerification: true,
    sendVerificationEmail: async ({ user, url }) => {
      const link = new URL(url);
      link.searchParams.set("callBackUrl", "/auth/verify"); //Redirect
      
      await sendEmailAction({
        to: user.email,
        subject: "Verify your email",
        meta: {
          description: `Please verify your address to complete registration.`,
          link: String(url),
        },
      });
    },
  },
```

> [!tip] **Verification**  
> 1. Start your dev server.  
> ```bash
> npm run dev
> ```  
> 2. Go to the sign-up form and register with a **new email** (it must be a real one).  
> 3. Try logging in immediately.  
>     - You should **not** be able to log in (blocked because email is not verified).  
> 4. Check the Gmail inbox for the test account.  
>     - Confirm that a **verification email** is received.  
> 5. Click the **verification link** in the email.  
> 6. After verification, try logging in again.  
>     - You should now be able to **log in successfully**.  
> 7. (Optional) Check your database `users` table:  
>     - Before verification → `emailVerified` field should be `null`.  
>     - After verification → `emailVerified` field should contain a **timestamp**.  
## Setup error handling
1. Go to `src/app/auth/` create a new folder called `verify` create a file inside called `page.tsx` 
```typescript
import { SendVerificationEmailForm } from "@/components/send-verification-email-form";
import { ReturnButton } from "@/components/ui/return-button";
import { redirect } from "next/navigation";

interface PageProps {
  searchParams: Promise<{ error: string }>;
}
  
export default async function Page({ searchParams }: PageProps) {
  const error = (await searchParams).error;

  if (!error) redirect("/profile");

  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Verify Email</h1>
      </div>
  
      <p className="text-destructive">
        {error == "invalid_token" || error == "token_expired"
          ? "Your email verification link is invalid. Please request a new one."
          : "An unknown error occurred."}
      </p>
      <SendVerificationEmailForm />
    </div>
  );
}
```
## Create a form to resend the verification email
1. Go to `src/components/` and create a new file called `send-verification-email-form.tsx`.
```typescript
"use client";

import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "./ui/button";
import { useState } from "react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { sendVerificationEmail } from "@/lib/auth-client";

export const SendVerificationEmailForm = () => {
  const [isPending, setIsPending] = useState(false);
  const router = useRouter();

  async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
    evt.preventDefault();
    const formData = new FormData(evt.currentTarget);
    const email = String(formData.get("email"));
  
    if (!email) return toast.error("Please enter your email");
  
    await sendVerificationEmail({
      email,
      callbackURL: "/auth/verify",
      fetchOptions: {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error(ctx.error.message);
        },
        onSuccess: () => {
          toast.success("Verification email sent!");
          router.push("/auth/verify/success");
        },
      },
    });
  }

  return (
    <form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
      <div className="flex flex-col gap-2">
        <Label htmlFor="email">Email</Label>
        <Input id="email" name="email" type="email" />
      </div>
      <Button type="submit" disabled={isPending}>
        Send Verification Email
      </Button>
    </form>
  );
};
```
2. Go to `src/lib/auth-client` and export sendVerificationEmail.
```typescript
export const {
  signUp,
  signOut,
  signIn,
  useSession,
  admin,
  sendVerificationEmail,
} = authClient;
```
3. Create the success page, go to `src/app/auth/verify` create a new folder called `success/` create a new file inside called `page.tsx`
```typescript
import { ReturnButton } from "@/components/ui/return-button";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Success</h1>
      </div>
  
      <p className="text-muted-foreground">
        A verification email has been sent to your email address. Please check
        your inbox and follow the instructions to verify your email.
      </p>
    </div>
  );
}
```
## Email verification recovery
1. Go to `src/actions/sign-in-email.action.ts` update the catch
```typescript
import { auth, ErrorCode } from "@/lib/auth";
import { redirect } from "next/navigation";

catch (err) {
    if (err instanceof APIError) {
      const errCode = err.body ? (err.body.code as ErrorCode) : "UNKNOWN";

      switch (errCode) {
        case "EMAIL_NOT_VERIFIED":
          redirect("/auth/verify?error=email_not_verified");
        default:
          return { error: err.message };
      }
    }
    
    return { error: "Internal server error occurred" };
  }
```
2. Go to `src/app/auth/verify/page.tsx` add the error code.
```typescript
<p className="text-destructive">
	{error == "invalid_token" || error == "token_expired"
	  ? "Your email verification link is invalid. Please request a new one."
	  : error == "email_not_verified"
	  ? "Please verify your email, or request a new verification below"
	  : "An unknown error occurred."}
</p>
```
3. Create the success page for the register page, go to `src/app/auth/register` create a new folder called `success/` create a new file inside called `page.tsx`
```typescript
import { ReturnButton } from "@/components/ui/return-button";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Success</h1>
      </div>

      <p className="text-muted-foreground">
        Success! You can now log in with your new account. Please check your email for the verification link.
      </p>
    </div>
  );
}
```
4. Go to `src/components/uiregister-form.tsx` to update the redirection
```typescript
if (error) {
      toast.error(error);
      setIsPending(false);
    } else {
      toast.success(
        "Registration successful!, Please check your email for the verification link."
      );
      router.push("/auth/register/success");
    }
```

> [!tip] **Verification**  
> 1. Start your dev server.  
> ```bash
> npm run dev
> ```  
> 2. Sign up with a **new email** and check that you are redirected to  
>    `/auth/register/success` with a success message telling you to verify your email.  
> 3. Try logging in without verifying your email.  
>     - You should be redirected to `/auth/verify?error=email_not_verified`.  
>     - The page should show: **"Please verify your email, or request a new verification below"**.  
> 4. Use the **"Send Verification Email"** form to request another link.  
>     - Enter your email.  
>     - Confirm a success toast appears: *"Verification email sent!"*.  
>     - You should be redirected to `/auth/verify/success`.  
> 5. Click the new verification link in your email.  
>     - You should now be able to **log in successfully**.  
> 6. Negative tests:  
>     - Open the verification page with an **expired token** → should display  
>       *"Your email verification link is invalid. Please request a new one."*  
>     - Open with an **invalid token** → same message should appear.  
>     - Open with **no error parameter** → should redirect to `/profile`.  
## Forgot Password
1. Go to `src/components/ui/login-form.tsx` update the password label.
```typescript
import Link from "next/link";

<div className="space-y-2">
	<div className="flex justify-between items-center gap-2">
	  <Label htmlFor="password">Password</Label>
	  <Link
		href="/auth/forgot-password"
		className="text-sm italic text-muted-foreground hover:text-foreground"
>	
		Forgot Password?
	  </Link>
	</div>
	<Input type="password" id="password" name="password" />
</div>
```
2. Create the forgot password page, go to `src/app/auth/` create a new folder called `forgot-password`, create a `page.tsx` file inside.
```typescript
import { ForgotPasswordForm } from "@/components/forgot-password-form";
import { ReturnButton } from "@/components/ui/return-button";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Success</h1>
      </div>
  
      <p className="text-muted-foreground">
        Please enter your email address to receive a password reset link.
      </p>
      
      <ForgotPasswordForm />
    </div>
  );
}
```
3. Go to `src/lib/auth.ts` and setup the forgot password functionality inside emailAndPassword.
```typescript
emailAndPassword: {
	enabled: true,
	minPasswordLength: 6,
	autoSignIn: false,
	password: {
	  hash: hashPassword, // your custom password hashing function
	  verify: verifyPassword, // your custom password verification function
	},
	requireEmailVerification: true,
	sendResetPassword: async ({ user, url }) => {
	  await sendEmailAction({
		to: user.email,
		subject: "Reset your password",
		meta: {
		  description: `Please click the link below to reset your password.`,
		  link: url,
		},
	  });
	},
},
```
3. Create a separate component for the forgot password form, go to `src/component/` create a new file called `forgot-password-form.tsx`.
```typescript
"use client";

import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "./ui/button";
import { useState } from "react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { forgetPassword, sendVerificationEmail } from "@/lib/auth-client";
  
export const ForgotPasswordForm = () => {
  const [isPending, setIsPending] = useState(false);
  const router = useRouter();
  
  async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
    evt.preventDefault();
    const formData = new FormData(evt.currentTarget);
    const email = String(formData.get("email"));

    if (!email) return toast.error("Please enter your email");
  
    await forgetPassword({
      email,
      redirectTo: "/auth/reset-password",
      fetchOptions: {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error(ctx.error.message);
        },
        onSuccess: () => {
          toast.success("Reset email sent!");
          router.push("/auth/forgot-password/success");
        },
      },
    });
  }

  return (
    <form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
      <div className="flex flex-col gap-2">
        <Label htmlFor="email">Email</Label>
        <Input id="email" name="email" type="email" />
      </div>
      <Button type="submit" disabled={isPending}>
        Send Reset Link
      </Button>
    </form>
  );
};
```
4. Go to `src/lib/auth-client` and export the forgotPasswordForm Function
```typescript
export const {
  signUp,
  signOut,
  signIn,
  useSession,
  admin,
  sendVerificationEmail,
  forgetPassword,
} = authClient;
```
5. Create a success page for forgot-password, go to `src/app/forgot-password/` create a new folder called `success` create a file inside called `page.tsx`.
```typescript
import { ReturnButton } from "@/components/ui/return-button";

export default function Page() {
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Success</h1>
      </div>

      <p className="text-muted-foreground">
        Success! You have sent a password reset link to your email address.
        Please check your inbox and follow the instructions to reset your
        password.
      </p>
    </div>
  );
}
```
### Setup the reset password page
1. Go to `src/app/auth/` create a new folder called `reset-password`, create a `page.tsx` file inside.
```typescript
import { ResetPasswordForm } from "@/components/reset-password-form";
import { ReturnButton } from "@/components/ui/return-button";
import { redirect } from "next/navigation";

interface PageProps {
    searchParams: Promise<{ token: string }>;
}

export default async function Page({ searchParams }: PageProps) {
    const token = (await searchParams).token;
  
    if(!token) redirect("/auth/login");
  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/auth/login" label="Back to Login" />
        <h1 className="text-3xl font-bold">Reset Password</h1>
      </div>
  
      <p className="text-muted-foreground">
        Please enter your new password below.
      </p>
      
      <ResetPasswordForm token={token} />
    </div>
  );
}
```
2. Create a reset password from component, go to `src/components` and create a new file called `reset-password-form.tsx`
```typescript
"use client";

import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "./ui/button";
import { useState } from "react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { resetPassword } from "@/lib/auth-client";

interface ResetPasswordFormProps {
  token: string;
}

export const ResetPasswordForm = ({ token }: ResetPasswordFormProps) => {
  const [isPending, setIsPending] = useState(false);
  const router = useRouter();
  
  async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
    evt.preventDefault();
    const formData = new FormData(evt.currentTarget);
    const password = String(formData.get("password"));
    if (!password) return toast.error("Please enter your password");
  
    const confirmPassword = String(formData.get("confirmPassword"));
    if (password !== confirmPassword)
      return toast.error("Passwords do not match");
  
    await resetPassword({
      newPassword: password,
      token,
      fetchOptions: {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error(ctx.error.message);
        },
        onSuccess: () => {
          toast.success("Password reset successfully!");
          router.push("/auth/login");
        },
      },
    });
  }

  return (
    <form onSubmit={handleSubmit} className="max-w-sm w-full space-y-4">
      <div className="flex flex-col gap-2">
        <Label htmlFor="password">New Password</Label>
        <Input id="password" name="password" type="password" />
      </div>
      <div className="flex flex-col gap-2">
        <Label htmlFor="confirmPassword">Confirm Password</Label>
        <Input id="confirmPassword" name="confirmPassword" type="password" />
      </div>
      <Button type="submit" disabled={isPending}>
        Reset Password
      </Button>
    </form>
  );
};
```
3. Go to `src/lib/auth-client.ts` and export he function.
```typescript
export const {
  signUp,
  signOut,
  signIn,
  useSession,
  admin,
  sendVerificationEmail,
  forgetPassword,
  resetPassword
} = authClient;
```

> [!tip] **Verification**  
> 1. Start your dev server.  
> ```bash
> npm run dev
> ```  
> 2. Go to the **Login** page and click **Forgot Password?**.  
>     - You should be redirected to `/auth/forgot-password`.  
> 3. Enter a valid email address for an existing user.  
>     - A toast should show *"Reset email sent!"*.  
>     - You should be redirected to `/auth/forgot-password/success`.  
> 4. Check your email inbox.  
>     - Confirm a **Reset Password email** is received with a link.  
> 5. Click the reset link.  
>     - You should be redirected to `/auth/reset-password?token=XYZ`.  
> 6. Enter a **new password** and confirm it.  
>     - If passwords do not match → error toast *"Passwords do not match"*.  
>     - If empty password → error toast *"Please enter your password"*.  
>     - If valid → toast *"Password reset successfully!"* and redirect to `/auth/login`.  
> 7. Try logging in with the **old password** → should fail.  
> 8. Try logging in with the **new password** → should succeed.  
> 9. Negative tests:  
>     - Open `/auth/reset-password` without a token → should redirect to `/auth/login`.  
>     - Use an **expired or invalid token** → should show an error toast from the API.  

# Part VII - update user, custom session, magic link
## Update user
1. Go to `src/app/profile/page.tsx` to add user image.
```typescript
import { SignOutButton } from "@/components/sign-out-button";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { ReturnButton } from "@/components/ui/return-button";
import { redirect } from "next/navigation";
import { Button } from "@/components/ui/button";
import Link from "next/link";

export default async function Page() {
  const headerList = await headers();
  
  const session = await auth.api.getSession({
    headers: headerList,
  });
  
  if (!session) {
    return redirect("/auth/login");
  }

  const FULL_POST_ACCESS = await auth.api.userHasPermission({
    headers: headerList,
    body: {
      permissions: {
        posts: ["update", "delete"],
      },
    },
  });

  return (
    <div className="px-8 py-16 container mx-auto max-w-screen-lg space-y-8">
      <div className="space-y-8">
        <ReturnButton href="/" label="Back to Home" />
        <h1 className="text-3xl font-bold">Profile</h1>
      </div>
  
      <div className="flex items-center gap-2">
        {session.user.role === "ADMIN" && (
          <Button size="sm" asChild>
            <Link href="/admin/dashboard">Admin Dashboard</Link>
          </Button>
        )}
        <SignOutButton />
      </div>

      <div className="text-2xl font-bold">Permissions </div>
      <div className="space-x-4">
        <Button size="sm">MANAGE OWN POSTS</Button>
        <Button size="sm" disabled={!FULL_POST_ACCESS.success}>
          MANAGE ALL POSTS
        </Button>
      </div>

      {session.user.image ? (
        <img
          src={session.user.image}
          alt="Profile Picture"
          className="size-24 border border-primary rounded-md object-cover"
        />
      ) : (
        <div className="size-24 border border-primary rounded-md bg-primary text-primary-foreground flex items-center justify-center">
          <span className="uppercase text-lg font-bold">
            {session.user.name.slice(0, 2)}
          </span>
        </div>
      )}

      <pre className="text-sm overflow-clip">
        {JSON.stringify(session, null, 2)}
      </pre>
      <div className="space-y-4 p-4 rounded-b-md border border-t-8 border-blue-600">
        <h2 className="text-2xl fontbold">Update User</h2>
        
        <UpdateUserForm
          name={session.user.name}
          image={session.user.image ?? ""}
        />
      </div>
    </div>
  );
}
```
2. Build a component to update user, go to `src/components/` create a new file `update-user-form.tsx`.
```typescript

```
3. Go to `src/lib/auth-client.ts` and export the function.
```typescript
export const {
  signUp,
  signOut,
  signIn,
  useSession,
  admin,
  sendVerificationEmail,
  forgetPassword,
  resetPassword,
  updateUser,
} = authClient;
```

> [!tip] **Verification**  
> 1. Start your dev server.  
> ```bash
> npm run dev
> ```  
> 2. Log in with a valid account and go to `/profile`.  
>     - The profile page should display your **name**, **permissions**, and **profile image** (or initials if no image is set).  
> 3. In the **Update User** form:  
>     - Change the **name** and click save → confirm the UI updates immediately and the new name is stored in the database.  
>     - Upload/change a **profile image URL** → confirm the new image is displayed instead of initials.  
> 4. Refresh the page.  
>     - The updated user details (name + image) should persist.  
> 5. Database check:  
>     - In the `users` table, confirm the `name` and/or `image` fields are updated for the logged-in user.  
> 6. Negative tests:  
>     - Try submitting the form with an **empty name** → should show an error.  
>     - Try uploading an **invalid image URL** → should fall back to initials without breaking the UI.  
## Update password
1. Go to `src/app/profile/page.tsx` and add below the update user section.
```typescript
<div className="space-y-4 p-4 rounded-b-md border border-t-8 border-red-600">
	<h2 className="text-2xl font-bold">Update Password</h2>
	
	<ChangePasswordForm />
</div>
```
2. Create a new component to change password, go to `src/components/` create a new file called `change-password-form.tsx`. (we are gonna do this on the server to showcase)
```typescript
"use client";

import React from "react";
import { Button } from "@/components/ui/button";
import { Label } from "@radix-ui/react-label";
import { Input } from "./ui/input";
import { changePasswordAction } from "@/actions/change-password.action";
import { toast } from "sonner";
  
export const ChangePasswordForm = () => {
  const [isPending, setIsPending] = React.useState(false);
  
  async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
    evt.preventDefault();
    setIsPending(true);
  
    const formData = new FormData(evt.target as HTMLFormElement);
  
    const { error } = await changePasswordAction(formData);

    if (error) {
      toast.error(error);
    } else {
      toast.success("Password changed successfully");
      (evt.target as HTMLFormElement).reset();
    }

    setIsPending(false);
  }

  return (
    <div>
      <form className="max-w-sm w-full space-y-4" onSubmit={handleSubmit}>
        <div className="flex flex-col gap-2">
          <Label htmlFor="currentPassword">Current Password</Label>
          <Input id="currentPassword" name="currentPassword" type="password" />
        </div>
        <div className="flex flex-col gap-2">
          <Label htmlFor="newPassword">New Password</Label>
          <Input id="newPassword" name="newPassword" type="password" />
        </div>
        <Button type="submit" disabled={isPending}>
          Update
        </Button>
      </form>
    </div>
  );
};
```
### Setup a server action to handle the change password
1. Go to `src/actions/` create a new file called `change-password.action.ts`.
```typescript
"use server";

import { auth } from "@/lib/auth";
import { APIError } from "better-auth/api";
import { headers } from "next/headers";
  
export async function changePasswordAction(formData: FormData) {
  const currentPassword = String(formData.get("currentPassword"));
  if (!currentPassword) return { error: "Please enter your current password" };
  
  const newPassword = String(formData.get("newPassword"));
  if (!newPassword) return { error: "Please enter a new password" };

  try {
    await auth.api.changePassword({
      headers: await headers(),
      body: {
        currentPassword,
        newPassword,
      },
    });
    return { error: null };
  } catch (err) {
    if (err instanceof APIError) {
      return { error: err.message };
    }
  
    return { error: "An unknown error occurred" };
  }
}
```

> [!tip] **Verification**  
> 1. Start your dev server.  
> ```bash
> npm run dev
> ```  
> 2. Log in with an existing user account.  
> 3. Go to `/profile` and scroll to the **Update Password** section.  
> 4. Enter your **current password** and a **new password**.  
>     - If the current password is wrong → you should see an **error toast**.  
>     - If both fields are empty → you should see the appropriate **validation error**.  
> 5. Enter the correct current password and a valid new one.  
>     - You should see a **success toast** ("Password changed successfully").  
>     - The form should reset automatically.  
> 6. Log out and try logging in again with the **new password**.  
>     - It should work.  
>     - The old password should no longer be valid.  
## Custom Sessions
1. Go to `src/lib/auth.ts` update the whole file to add the custom session plugin.
```typescript
import { betterAuth, type BetterAuthOptions } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { nextCookies } from "better-auth/next-js"; // import nextCookies
import { createAuthMiddleware, APIError } from "better-auth/api";
import { admin, customSession } from "better-auth/plugins";

import { prisma } from "@/lib/prisma";
import { hashPassword, verifyPassword } from "@/lib/argon2";
import { getValidDomains, normalizeName } from "@/lib/utils";
import { UserRole } from "@/generated/prisma";
import { ac, roles } from "@/lib/permissions";
import { sendEmailAction } from "@/actions/send-email.action";

const options = {
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  }),
  socialProviders: {
    google: {
      clientId: String(process.env.GOOGLE_CLIENT_ID),
      clientSecret: String(process.env.GOOGLE_CLIENT_SECRET),
    },
    github: {
      clientId: String(process.env.GITHUB_CLIENT_ID),
      clientSecret: String(process.env.GITHUB_CLIENT_SECRET),
    },
  },
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 6,
    autoSignIn: false,
    password: {
      hash: hashPassword, // your custom password hashing function
      verify: verifyPassword, // your custom password verification function
    },
    requireEmailVerification: true,
    sendResetPassword: async ({ user, url }) => {
      await sendEmailAction({
        to: user.email,
        subject: "Reset your password",
        meta: {
          description: `Please click the link below to reset your password.`,
          link: url,
        },
      });
    },
  },
  emailVerification: {
    sendOnSignUp: true,
    autoSignInAfterVerification: true,
    sendVerificationEmail: async ({ user, url }) => {
      const link = new URL(url);
      link.searchParams.set("callBackUrl", "/auth/verify");
  
      await sendEmailAction({
        to: user.email,
        subject: "Verify your email",
        meta: {
          description: `Please verify your address to complete registration.`,
          link: String(link),
        },
      });
    },
  },
  hooks: {
    before: createAuthMiddleware(async (ctx) => {
      if (ctx.path == "/sign-up/email") {
        const email = String(ctx.body.email);
        const domain = email.split("@")[1];
        const VALID_DOMAINS = getValidDomains();
        if (!VALID_DOMAINS.includes(domain)) {
          throw new APIError("BAD_REQUEST", {
            message: "Invalid email domain. Please use a valid email.",
          });
        }
        const name = normalizeName(ctx.body.name);

        return {
          context: {
            ...ctx,
            body: {
              ...ctx.body,
              name,
            },
          },
        };
      }
    }),
  },
  databaseHooks: {
    user: {
      create: {
        before: async (user) => {
          const ADMIN_EMAILS = process.env.ADMIN_EMAILS?.split(";") || [];
  
          if (ADMIN_EMAILS.includes(user.email)) {
            return { data: { ...user, role: UserRole.ADMIN } }; // set role to ADMIN if email is in the list
          }

          return { data: user };
        },
      },
    },
  },
  user: {
    additionalFields: {
      role: {
        type: ["USER", "ADMIN"] as Array<UserRole>,
        input: false,
      },
    },
  },
  session: {
    expiresIn: 30 * 24 * 60 * 60, // session expiration time in seconds
  },
  account: {
    accountLinking: {
      enabled: false,
    },
  },
  advanced: {
    database: {
      generateId: false,
    },
  },
  plugins: [
    nextCookies(),
    admin({
      defaultRole: UserRole.USER, // default role for new users
      adminRoles: [UserRole.ADMIN],
      ac,
      roles,
    }),
  ], // add the nextCookies and customSession plugins
} satisfies BetterAuthOptions;
  
export const auth = betterAuth({
  ...options,
  plugins: [
    ...(options.plugins ?? []),
    customSession(async ({ user, session }) => {
      return {
        session: {
          expiresAt: session.expiresAt,
          tokenL: session.token,
          userAgent: session.userAgent,
        },
        user: {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role,
          image: user.image,
        },
      };
    }, options),
  ],
});

export type ErrorCode = keyof typeof auth.$ERROR_CODES | "UNKNOWN";
```
2. Update `src/lib/auth-client.ts` to infer the custom session from auth.
```typescript
import {
  inferAdditionalFields,
  adminClient,
  customSessionClient,
} from "better-auth/client/plugins";

export const authClient = createAuthClient({
  /** The base URL of the server (optional if you're using the same domain) */
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  plugins: [
    inferAdditionalFields<typeof auth>(),
    adminClient({ ac, roles }),
    customSessionClient<typeof auth>(),
  ],
});
```

> [!tip] **Verification**  
> 1. Start your dev server.  
> ```bash
> npm run dev
> ```  
> 2. Log in with a valid account.  
> 3. Navigate to the **Profile page**.  
> 4. Confirm that both the **session values** (e.g., `expiresAt`, `token`, `userAgent`) and the **user values** (e.g., `id`, `email`, `name`, `role`, `image`) are displayed correctly.  
## Use magic Link plugin from better auth
> [!note]
>[**Magic link**](https://www.better-auth.com/docs/plugins/magic-link)
>Magic link or email link is a way to authenticate users without a password. When a user enters their email, a link is sent to their email. When the user clicks on the link, they are authenticated.
1. Go to `src/lib/auth.ts` import magic link plugin.
```typescript
import { admin, customSession, magicLink } from "better-auth/plugins";

//add below nextCookies() plugin
magicLink({
  sendMagicLink: async ({email, url}) => {
	await sendEmailAction({
	  to: email,
	  subject: "Your Magic Link",
	  meta: {
		description: `Click the link below to log in:`,
		link: url,
	  },
	});
  }
}),
```
3. import into `src/lib/auth-client.ts`
```typescript
import { createAuthClient } from "better-auth/react";
import {
  inferAdditionalFields,
  adminClient,
  customSessionClient,
  magicLinkClient
} from "better-auth/client/plugins";
import type { auth } from "@/lib/auth";
import { ac, roles } from "@/lib/permissions";

export const authClient = createAuthClient({
  /** The base URL of the server (optional if you're using the same domain) */
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  plugins: [
    inferAdditionalFields<typeof auth>(),
    adminClient({ ac, roles }),
    customSessionClient<typeof auth>(),
    magicLinkClient(),
  ],
});

export const {
  signUp,
  signOut,
  signIn,
  useSession,
  admin,
  sendVerificationEmail,
  forgetPassword,
  resetPassword,
  updateUser,
} = authClient;
```
### Build a magic link component
1. Go to `src/components/` create a new file called `magic-link-form.tsx`.
```typescript
"use client";

import { StarIcon } from "lucide-react";
import { useRef, useState } from "react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { signIn } from "@/lib/auth-client";
import { toast } from "sonner";

export const MagicLinkForm = () => {
  const [isPending, setIsPending] = useState(false);
  const ref = useRef<HTMLDetailsElement>(null);

  async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {
    evt.preventDefault();

    const formData = new FormData(evt.currentTarget as HTMLFormElement);
    const email = String(formData.get("email"));
    if (!email) return toast.error("Please enter your email");

    await signIn.magicLink({
      email,
      name: email.split("@")[0],
      callbackURL: "/profile",
      fetchOptions: {
        onRequest: () => {
          setIsPending(true);
        },
        onResponse: () => {
          setIsPending(false);
        },
        onError: (ctx) => {
          toast.error(ctx.error.message);
        },
        onSuccess: () => {
          toast.success("Check your email for the magic link!");
          if (ref.current) ref.current.open = false;
          (evt.target as HTMLFormElement).reset();
        },
      },
    });
  }

  return (
    <details
      ref={ref}
      className="max-w-sm rounded-md border border-purple-600 overflow-hidden"
    >
      <summary className="flex gap-2 items-center px-2 py-1 bg-purple-600 text-white hover:-bg-purple-600/80 transition">
        Try Magic Link <StarIcon size={16} />
      </summary>

      <form onSubmit={handleSubmit} className="px-2 py-1">
        <Label htmlFor="email" className="sr-only">
          Email
        </Label>

        <div className="flex gap-2 items-center">
          <Input
            type="email"
            id="email"
            name="email"
            placeholder="Enter your email"
          />
          <Button type="submit" disabled={isPending}>
            Send
          </Button>
        </div>
      </form>
    </details>
  );
};
```
2. Import into the login page, go to `src/app/auth/login/page.tsx`.
```typescript
import { MagicLinkForm } from "@/components/magic-link-form";

// Add below <div className="text-muted-foreground test-sm">
<MagicLinkForm />
```
## Configure Normalize hook to run with magic link and update user
1. Go to `src/lib/auth.ts` and update the hook.
```typescript
hooks: {
    before: createAuthMiddleware(async (ctx) => {
      if (ctx.path == "/sign-up/email") {
        const email = String(ctx.body.email);
        const domain = email.split("@")[1];
        const VALID_DOMAINS = getValidDomains();
        
        if (!VALID_DOMAINS.includes(domain)) {
          throw new APIError("BAD_REQUEST", {
            message: "Invalid email domain. Please use a valid email.",
          });
        }
        const name = normalizeName(ctx.body.name);
  
        return {
          context: { ...ctx, body: { ...ctx.body, name } },
        };
      }

      if (ctx.path === "/sign-in/magic-link") {
        const name = normalizeName(ctx.body.name);
        
        return {
          context: { ...ctx, body: { ...ctx.body, name } },
        };
      }

      if (ctx.path === "/update-user") {
        const name = normalizeName(ctx.body.name);
        
        return {
          context: { ...ctx, body: { ...ctx.body, name } },
        };
      }
    }),
  },
```
## Setup Cookie Cashing

>[!note]
>[**Cookie Cache**](https://www.better-auth.com/docs/concepts/session-management#cookie-cache)
>
>Calling your database every time `useSession` or `getSession` invoked isn’t ideal, especially if sessions don’t change frequently. Cookie caching handles this by storing session data in a short-lived, signed cookie—similar to how JWT access tokens are used with refresh tokens.
>
>When cookie caching is enabled, the server can check session validity from the cookie itself instead of hitting the database each time. The cookie is signed to prevent tampering, and a short `maxAge` ensures that the session data gets refreshed regularly. If a session is revoked or expires, the cookie will be invalidated automatically.
1. Go to `src/lib/auth.ts` update the session property.
```typescript
session: {
	expiresIn: 30 * 24 * 60 * 60, // session expiration time in seconds
	cookieCache: {
	  enabled: true,
	  maxAge: 5 * 60,
	},
},
```
# References
- [Next.js Documentation](https://nextjs.org/docs)
- [Better Auth Documentation](https://www.better-auth.com/docs)
- [Prisma ORM Documentation](https://www.prisma.io/docs)
- [Neon Database](https://neon.tech)
- [Nodemailer](https://nodemailer.com/about/)

# Credits to
[GiraffeReactor](https://www.youtube.com/@GiraffeReactor)